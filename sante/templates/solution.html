<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MediTrack Pro — Gestion Médicale Intelligente</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --primary-light: #eef2ff;
      --primary-gradient: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%);
      --secondary: #7209b7;
      --secondary-light: #f3e8ff;
      --secondary-gradient: linear-gradient(135deg, #7209b7 0%, #6a08a6 100%);
      --success: #4cc9f0;
      --success-light: #e6f7ff;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --danger: #e63946;
      --danger-light: #ffe6e9;
      --warning: #ffb703;
      --card-bg: #ffffff;
      --sidebar-bg: #f1f5f9;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 10px 30px rgba(67, 97, 238, 0.15);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.2s ease;
      --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      --radius: 16px;
      --radius-sm: 8px;
      --glass: rgba(255, 255, 255, 0.9);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
      color: var(--dark);
      overflow-x: hidden;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 20% 80%, rgba(67, 97, 238, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(114, 9, 183, 0.1) 0%, transparent 50%);
      z-index: -1;
    }
    /* Utilities */
    .hidden {
      display: none !important;
    }
  
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .justify-between { justify-content: space-between; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .gap-4 { gap: 1rem; }
    .gap-6 { gap: 1.5rem; }
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-5 { padding: 1.25rem; }
    .p-6 { padding: 1.5rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .rounded-lg { border-radius: var(--radius-sm); }
    .rounded-xl { border-radius: var(--radius); }
    .rounded-2xl { border-radius: 1.5rem; }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .font-bold { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .text-sm { font-size: 0.875rem; }
    .text-base { font-size: 1rem; }
    .text-lg { font-size: 1.125rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-3xl { font-size: 1.875rem; }
    .cursor-pointer { cursor: pointer; }
    .w-full { width: 100%; }
    .w-auto { width: auto; }
    .max-w-4xl { max-width: 80rem; }
    .overflow-auto { overflow: auto; }
    .transition-all { transition: var(--transition); }
    .relative { position: relative; }
    .absolute { position: absolute; }
    .mt-4 { margin-top: 1rem; }
    .mt-6 { margin-top: 1.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .my-6 { margin: 1.5rem 0; }
    .uppercase-input { text-transform: uppercase; }
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
  
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
  
    @keyframes ripple {
      0% { transform: scale(0); opacity: 0.5; }
      20% { transform: scale(25); opacity: 0.3; }
      100% { transform: scale(40); opacity: 0; }
    }
  
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
  
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(67, 97, 238, 0.5); }
      50% { box-shadow: 0 0 20px rgba(67, 97, 238, 0.8); }
    }
  
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
  
    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }
  
    @keyframes bounceIn {
      0% { opacity: 0; transform: scale(0.8); }
      70% { opacity: 1; transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }
    .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
    .animate-slideUp { animation: slideUp 0.5s ease-out; }
    .animate-slideDown { animation: slideDown 0.4s ease-out; }
    .animate-slideIn { animation: slideIn 0.4s ease-out; }
    .animate-pulse { animation: pulse 2s infinite; }
    .animate-glow { animation: glow 2s infinite; }
    .animate-float { animation: float 3s ease-in-out infinite; }
    .animate-bounceIn { animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
  
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
  
    .btn:hover::before {
      left: 100%;
    }
  
    .btn-primary {
      background: var(--primary-gradient);
      color: white;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    }
  
    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }
  
    .btn-secondary {
      background: var(--secondary-gradient);
      color: white;
      box-shadow: 0 4px 12px rgba(114, 9, 183, 0.3);
    }
  
    .btn-secondary:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(114, 9, 183, 0.25);
    }
  
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
  
    .btn-outline:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-3px);
    }
  
    .btn-glass {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--dark);
    }
  
    .btn-glass:hover {
      background: white;
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }
  
    .btn-back {
      background: var(--gray-light);
      color: var(--gray);
      padding: 0.6rem 1.2rem;
    }
  
    .btn-back:hover {
      background: #dee2e6;
      transform: translateX(-3px);
    }
  
    .btn-icon {
      padding: 0.6rem;
      border-radius: 50%;
      width: 2.5rem;
      height: 2.5rem;
    }
  
    .btn-shimmer {
      background: linear-gradient(90deg,
        var(--primary) 0%,
        #4cc9f0 25%,
        var(--primary) 50%,
        #4cc9f0 75%,
        var(--primary) 100%);
      background-size: 200% auto;
      animation: shimmer 3s infinite linear;
    }
    /* Alerts */
    .alert {
      padding: 0.875rem 1rem;
      border-radius: var(--radius-sm);
      margin: 1rem 0;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      animation: slideIn 0.4s ease-out;
      border-left: 4px solid;
      backdrop-filter: blur(10px);
    }
  
    .alert-success {
      background: linear-gradient(90deg, #d1e7dd, #c3e6cb);
      color: #0f5132;
      border-left-color: #198754;
    }
  
    .alert-error {
      background: linear-gradient(90deg, #f8d7da, #f5c6cb);
      color: #842029;
      border-left-color: #dc3545;
    }
  
    .alert-warning {
      background: linear-gradient(90deg, #fff3cd, #ffeaa7);
      color: #664d03;
      border-left-color: #ffc107;
    }
  
    .alert-info {
      background: linear-gradient(90deg, #cff4fc, #b8e6f9);
      color: #055160;
      border-left-color: #0dcaf0;
    }
    /* Form Controls */
    .form-group {
      margin-bottom: 1.25rem;
      position: relative;
    }
  
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--dark);
      font-size: 0.9rem;
    }
  
    .form-control {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      transition: var(--transition);
      background: white;
      backdrop-filter: blur(10px);
    }
  
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
      transform: translateY(-2px);
    }
  
    .form-control::placeholder {
      color: #a0aec0;
    }
  
    select.form-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 16px 12px;
      padding-right: 2.5rem;
      text-transform: none;
    }
    .uppercase-input { text-transform: uppercase; }
    /* Layout */
    #authScreen,
    #appContainer {
      width: 100%;
      display: flex;
      flex-direction: column;
      animation: fadeIn 0.6s ease-out;
    }
    /* Auth Screen */
    #authScreen {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
      min-height: 100vh;
      justify-content: center;
      padding: 2rem 1rem;
    }
  
    .auth-container {
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2.5rem;
      max-width: 500px;
      width: 100%;
      margin: 0 auto;
      animation: slideUp 0.5s ease-out;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
  
    .app-logo {
      text-align: center;
      margin-bottom: 2rem;
      animation: float 3s ease-in-out infinite;
    }
  
    .app-logo h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary);
    }
  
    .app-logo h1 .gradient-text {
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
  
    .app-logo p {
      color: var(--gray);
      font-size: 1rem;
    }
    /* Header */
    .app-header {
      background: var(--glass);
      padding: 1rem 2rem;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
      position: sticky;
      top: 0;
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }
  
    .logo {
      font-size: 1.75rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--primary);
    }
  
    .logo i {
      font-size: 1.5rem;
      animation: pulse 2s infinite;
      color: var(--primary);
    }
  
    .user-info {
      font-weight: 600;
      color: var(--gray);
      background: var(--primary-light);
      padding: 0.5rem 1rem;
      border-radius: 50px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      backdrop-filter: blur(10px);
    }
  
    .user-info i {
      color: var(--primary);
    }
    /* Navigation */
    .nav-breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      padding: 0.75rem 1.5rem;
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
  
    .breadcrumb-item {
      color: var(--gray);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition-fast);
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
    }
  
    .breadcrumb-item:hover {
      background: var(--primary-light);
      color: var(--primary);
    }
  
    .breadcrumb-item.active {
      color: var(--primary);
      font-weight: 600;
    }
  
    .breadcrumb-separator {
      color: #ced4da;
    }
  
    .nav-controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    /* Main Menu */
    #mainMenu {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
  
    .menu-card {
      background: var(--glass);
      border-radius: var(--radius);
      padding: 2rem 1.5rem;
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.3);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
  
    .menu-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--primary-gradient);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s ease;
    }
  
    .menu-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: var(--shadow-hover);
      border-color: var(--primary);
    }
  
    .menu-card:hover::before {
      transform: scaleX(1);
    }
  
    .menu-card i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--primary);
      animation: float 3s ease-in-out infinite;
    }
  
    .menu-card h3 {
      font-size: 1.375rem;
      margin-bottom: 0.75rem;
      color: var(--dark);
    }
  
    .menu-card p {
      color: var(--gray);
      font-size: 0.95rem;
      line-height: 1.5;
    }
    /* Content Areas */
    .content-area {
      display: none;
    }
  
    .content-area.active {
      display: block;
      animation: slideUp 0.5s ease-out;
    }
    .content-header {
      margin-bottom: 2rem;
      background: var(--glass);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
  
    .content-header h2 {
      font-size: 1.875rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
  
    .content-header p {
      color: var(--gray);
      font-size: 1rem;
    }
    /* Patient List */
    .patients-list-container {
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-top: 1rem;
      max-height: 500px;
      overflow-y: auto;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
  
    .patient-search-card {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--gray-light);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
    }
  
    .patient-search-card:hover {
      background: var(--primary-light);
      transform: translateX(5px);
      border-radius: var(--radius-sm);
    }
  
    .patient-search-card:last-child {
      border-bottom: none;
    }
  
    .patient-search-card .patient-info h4 {
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
      color: var(--dark);
    }
  
    .patient-search-card .patient-info p {
      color: var(--gray);
      font-size: 0.9rem;
    }
  
    .patient-search-card .patient-actions {
      display: flex;
      gap: 0.5rem;
    }
  
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--gray-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }
  
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Patient Details */
    #patientDetails {
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-top: 1.5rem;
      padding: 1.5rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
  
    .details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
  
    .detail-item {
      background: var(--primary-light);
      padding: 1rem;
      border-radius: var(--radius-sm);
      backdrop-filter: blur(10px);
    }
  
    .detail-item label {
      font-size: 0.85rem;
      color: var(--gray);
      margin-bottom: 0.25rem;
      display: block;
    }
  
    .detail-item p {
      font-weight: 600;
      color: var(--dark);
    }
  
    .details-section-header {
      margin: 1.5rem 0 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--primary);
      color: var(--primary);
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
  
    .consultation-item {
      background: var(--glass);
      padding: 1.25rem;
      border-radius: var(--radius-sm);
      margin-bottom: 1rem;
      border-left: 4px solid var(--primary);
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: var(--transition);
      backdrop-filter: blur(10px);
    }
  
    .consultation-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
  
    .consultation-item.other-service {
      border-left-color: var(--secondary);
      background: var(--secondary-light);
    }
  
    .consultation-item .consultation-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
  
    .consultation-item .consultation-date {
      font-weight: 600;
      color: var(--primary);
    }
  
    .consultation-item .consultation-service {
      background: var(--gray-light);
      color: var(--gray);
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.85rem;
    }
    /* Prescription Editor */
    #prescriptionContent {
      font-family: 'Courier New', 'Consolas', monospace;
      font-size: 1rem;
      min-height: 350px;
      padding: 1.25rem;
      border: 2px solid #e2e8f0;
      border-radius: var(--radius-sm);
      white-space: pre-wrap;
      word-wrap: break-word;
      resize: vertical;
      background: #f8f9fa;
      line-height: 1.5;
      transition: var(--transition);
      backdrop-filter: blur(10px);
    }
  
    #prescriptionContent:focus {
      border-color: var(--primary);
      background: white;
      transform: translateY(-2px);
    }
  
    .editor-toolbar {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    /* Registry Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2rem;
    }
  
    .stat-card {
      background: var(--glass);
      padding: 1.5rem;
      border-radius: var(--radius);
      text-align: center;
      box-shadow: var(--shadow);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
  
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }
  
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--primary-gradient);
    }
  
    .stat-icon {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: var(--primary);
      animation: float 3s ease-in-out infinite;
    }
  
    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary);
      margin: 0.5rem 0;
      line-height: 1;
    }
  
    .stat-label {
      color: var(--gray);
      font-size: 0.95rem;
    }
  
    .disease-stats-table {
      width: 100%;
      background: var(--glass);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
  
    .disease-stats-table pre {
      margin: 0;
      padding: 1.5rem;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      overflow-x: auto;
    }
    /* Filters */
    .filters-container {
      background: var(--glass);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
  
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }
    /* Footer */
    .app-footer {
      margin-top: auto;
      padding: 1.5rem 2rem;
      text-align: center;
      color: var(--gray);
      font-size: 0.9rem;
      background: var(--glass);
      border-top: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(20px);
    }
    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      max-width: 400px;
    }
  
    .notification.success {
      background: linear-gradient(135deg, #198754 0%, #146c43 100%);
    }
  
    .notification.error {
      background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%);
    }
  
    .notification.warning {
      background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
      color: #212529;
    }
    /* Progress Bar */
    .progress-bar {
      height: 4px;
      background: var(--primary-light);
      border-radius: 2px;
      overflow: hidden;
      margin: 1rem 0;
    }
  
    .progress-fill {
      height: 100%;
      background: var(--primary-gradient);
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    /* Responsive */
    @media (max-width: 1024px) {
      .filters-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  
    @media (max-width: 768px) {
      .app-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
        padding: 1rem;
      }
      #mainMenu {
        grid-template-columns: 1fr;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .filters-grid {
        grid-template-columns: 1fr;
      }
      .details-grid {
        grid-template-columns: 1fr;
      }
      .auth-container {
        padding: 1.5rem;
      }
      .nav-breadcrumb {
        flex-wrap: wrap;
      }
    }
    @media (max-width: 480px) {
      .content-header h2 {
        font-size: 1.5rem;
      }
      .btn {
        padding: 0.625rem 1rem;
        font-size: 0.9rem;
      }
      .notification {
        left: 20px;
        right: 20px;
        max-width: none;
      }
    }
    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(241, 241, 241, 0.5);
      border-radius: 4px;
      backdrop-filter: blur(10px);
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(193, 193, 193, 0.7);
      border-radius: 4px;
      backdrop-filter: blur(10px);
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(161, 161, 161, 0.9);
    }
    /* Grid utilities */
    .grid {
      display: grid;
    }
    .grid-cols-1 {
      grid-template-columns: repeat(1, 1fr);
    }
    .grid-cols-2 {
      grid-template-columns: repeat(2, 1fr);
    }
  
    .min-w-\[200px\] {
      min-width: 200px;
    }
    /* Hover effects */
    .hover-lift {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .hover-lift:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }
    /* Glass effect */
    .glass {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body>
  <!-- Notification System -->
  <div id="notificationContainer"></div>
  <!-- Auth Screen -->
  <div id="authScreen" class="flex items-center justify-center">
    <div class="auth-container">
      <div class="app-logo">
        <h1><i class="fas fa-heartbeat"></i> <span class="gradient-text">MediTrack Pro</span></h1>
        <p>Système de gestion médicale intelligent et sécurisé</p>
      </div>
      <div id="registerView" class="hidden">
        <h2 class="text-2xl font-bold mb-6 text-center">Créer un compte</h2>
        <form id="registerForm">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="form-group">
              <label>Prénom *</label>
              <input type="text" id="regFirstName" class="form-control uppercase-input" required />
            </div>
            <div class="form-group">
              <label>Nom *</label>
              <input type="text" id="regLastName" class="form-control uppercase-input" required />
            </div>
          </div>
        
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="form-group">
              <label>Nom d'utilisateur *</label>
              <input type="text" id="regUsername" class="form-control" required />
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="regEmail" class="form-control" required />
            </div>
          </div>
        
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="form-group">
              <label>Téléphone</label>
              <input type="text" id="regPhone" class="form-control" />
            </div>
            <div class="form-group">
              <label>Rôle *</label>
              <select id="regRole" class="form-control">
                <option>Professeur</option>
                <option>Médecin</option>
                <option>Infirmier(ère)</option>
                <option>TSO</option>
                <option>TAR</option>
                <option>TRIM</option>
                <option>Sage-femme</option>
                <option>Orthophoniste</option>
                <option>Kiné</option>
                <option>Opticien</option>
                <option>Administrateur</option>
              </select>
            </div>
          </div>
        
          <div class="form-group mb-4">
            <label>Service</label>
            <select id="regService" class="form-control"></select>
            <div id="otherServiceGroup" class="form-group hidden mt-2">
              <label>Précisez le service</label>
              <input type="text" id="regOtherService" class="form-control uppercase-input" />
            </div>
          </div>
        
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="form-group">
              <label>Mot de passe *</label>
              <input type="password" id="regPassword" class="form-control" required minlength="6" />
            </div>
            <div class="form-group">
              <label>Confirmer *</label>
              <input type="password" id="regConfirmPassword" class="form-control" required />
            </div>
          </div>
        
          <div id="authAlert"></div>
          <button type="submit" class="btn btn-primary w-full animate-pulse">
            <i class="fas fa-user-plus"></i> S'inscrire
          </button>
          <div class="text-center mt-4">
            <a href="#" onclick="toggleAuthView('login')" class="text-primary font-semibold hover:underline transition-all">
              <i class="fas fa-sign-in-alt"></i> Déjà inscrit ? Se connecter
            </a>
          </div>
        </form>
      </div>
      <div id="loginView">
        <h2 class="text-2xl font-bold mb-6 text-center animate-bounceIn">Se connecter</h2>
        <form id="loginForm">
          <div class="form-group mb-4">
            <label>Email ou Nom d'utilisateur *</label>
            <input type="text" id="userEmail" class="form-control" required />
          </div>
          <div class="form-group mb-6">
            <label>Mot de passe *</label>
            <input type="password" id="userPassword" class="form-control" required />
          </div>
          <div id="authAlert"></div>
          <button type="submit" class="btn btn-primary w-full animate-pulse">
            <i class="fas fa-sign-in-alt"></i> Connexion
          </button>
          <div class="text-center mt-4">
            <a href="#" onclick="toggleAuthView('register')" class="text-primary font-semibold hover:underline transition-all">
              <i class="fas fa-user-plus"></i> Pas encore de compte ? S'inscrire
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- App Container -->
  <div id="appContainer" class="hidden flex-col">
    <div class="app-header animate-slideDown">
      <div class="logo">
        <i class="fas fa-heartbeat"></i>
        <span>MediTrack Pro</span>
      </div>
      <div class="user-info" id="currentUserInfo"></div>
    </div>
    <div class="p-6 flex-1">
      <!-- Navigation Breadcrumb -->
      <div id="navBreadcrumb" class="nav-breadcrumb hidden">
        <div id="breadcrumbContent"></div>
      </div>
      <!-- Navigation Controls -->
      <div id="navControls" class="nav-controls">
        <button class="btn btn-back" onclick="goBack()">
          <i class="fas fa-arrow-left"></i> Retour
        </button>
        <button class="btn btn-outline" onclick="showMainMenu()">
          <i class="fas fa-home"></i> Accueil
        </button>
      </div>
      <!-- Main Menu -->
      <div id="mainMenu">
        <div class="menu-card animate-bounceIn" onclick="showSection('newConsultation')">
          <i class="fas fa-user-plus"></i>
          <h3>Nouvelle Consultation</h3>
          <p>Créer un dossier patient</p>
        </div>
        <div class="menu-card animate-bounceIn" style="animation-delay: 0.1s" onclick="showSection('oldConsultation')">
          <i class="fas fa-history"></i>
          <h3>Ancienne Consultation</h3>
          <p>Rechercher un patient</p>
        </div>
        <div class="menu-card animate-bounceIn" style="animation-delay: 0.2s" onclick="showSection('registry')">
          <i class="fas fa-chart-bar"></i>
          <h3>Registre & Statistiques</h3>
          <p>Données agrégées</p>
        </div>
        <div class="menu-card animate-bounceIn" style="animation-delay: 0.3s" onclick="showSection('settings')">
          <i class="fas fa-cog"></i>
          <h3>Paramètres</h3>
          <p>Gérer votre profil</p>
        </div>
        <div class="menu-card animate-bounceIn" style="animation-delay: 0.4s" onclick="clearAuthData()">
          <i class="fas fa-sign-out-alt"></i>
          <h3>Déconnexion</h3>
          <p>Quitter la session</p>
        </div>
      </div>
      <!-- New Consultation -->
      <div id="newConsultation" class="content-area">
        <div class="content-header">
          <h2><i class="fas fa-user-plus"></i> Nouvelle Consultation</h2>
          <p>Créez un nouveau dossier patient</p>
        </div>
        <div class="glass p-6 rounded-xl shadow hover-lift">
          <form id="newPatientForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
  <div class="form-group">
    <label>Prénom du patient *</label>
    <input type="text" id="patientPrenom" class="form-control uppercase-input" required placeholder="Ex: Fatoumata" />
  </div>
  <div class="form-group">
    <label>Nom du patient *</label>
    <input type="text" id="patientNom" class="form-control uppercase-input" required placeholder="Ex: Diallo" />
  </div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
  <div class="form-group">
    <label>Âge *</label>
    <input type="number" step="0.1" id="patientAge" class="form-control" required placeholder="Ex: 25 ou 0.5" />
  </div>
  
</div>
          
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Sexe *</label>
                <select id="patientGender" class="form-control" required>
                  <option value="M">Masculin</option>
                  <option value="F">Féminin</option>
                </select>
              </div>
              <div class="form-group">
                <label>Profession</label>
                <input type="text" id="patientProfession" class="form-control" />
              </div>
            </div>
          
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Téléphone</label>
                <input type="text" id="patientPhone" class="form-control" />
              </div>
              <div class="form-group">
                <label>Adresse</label>
                <input type="text" id="patientAddress" class="form-control" />
              </div>
            </div>
          
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Groupe sanguin</label>
                <input type="text" id="patientBloodGroup" class="form-control uppercase-input" placeholder="Ex: A, B, AB, O" />
              </div>
              <div class="form-group">
                <label>Rhésus</label>
                <select id="patientRhesus" class="form-control">
                  <option value="">Non spécifié</option>
                  <option value="+">+</option>
                  <option value="-">-</option>
                </select>
              </div>
            </div>
          
            <div class="form-group mb-6">
              <label>Service d'enregistrement initial</label>
              <select id="serviceType" class="form-control"></select>
              <div id="otherServiceGroupNew" class="form-group hidden mt-2">
                <label>Précisez le service</label>
                <input type="text" id="otherServiceNew" class="form-control uppercase-input" />
              </div>
            </div>
          
            <div id="newConsultAlert"></div>
            <div class="flex gap-4">
              <button type="submit" class="btn btn-primary animate-glow">
                <i class="fas fa-arrow-right"></i> Continuer vers la prescription
              </button>
              <button type="button" class="btn btn-outline" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Retour
              </button>
            </div>
          </form>
        </div>
      </div>
      <!-- Prescription Editor -->
      <div id="prescriptionEditor" class="content-area">
        <div class="content-header">
          <h2><i class="fas fa-file-medical"></i> Éditeur de Prescription</h2>
          <p id="currentPatientNameDisplay2" class="text-gray"></p>
        </div>
        <div id="prescriptionHeader" class="mb-4 p-4 bg-light rounded border"></div>
        <div class="glass p-6 rounded-xl shadow hover-lift">
          <div class="editor-toolbar">
            <button class="btn btn-secondary animate-pulse" onclick="addSection()">
              <i class="fas fa-plus"></i> Ajouter Section
            </button>
            <button class="btn btn-secondary animate-pulse" onclick="addTable()">
              <i class="fas fa-table"></i> Ajouter Tableau
            </button>
            <button class="btn btn-outline" onclick="showSection('newConsultation')">
              <i class="fas fa-edit"></i> Modifier Patient
            </button>
            <button class="btn btn-primary" onclick="exportToPDF()">
              <i class="fas fa-file-pdf"></i> Exporter en PDF
            </button>
            <button class="btn btn-primary" onclick="exportToWord()">
              <i class="fas fa-file-word"></i> Exporter en Word
            </button>
          </div>
        
          <form id="prescriptionForm">
            <textarea id="prescriptionContent" class="w-full" placeholder="Commencez à rédiger la prescription ici..."></textarea>
            <div id="editorAlert" class="mt-3"></div>
            <div class="flex gap-3 mt-4">
              <button type="submit" class="btn btn-primary btn-shimmer">
                <i class="fas fa-arrow-right"></i> Suivant : Résumé Médical
              </button>
              <button type="button" class="btn btn-outline" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Retour
              </button>
            </div>
          </form>
        </div>
      </div>
      <!-- Medical Summary -->
      <div id="medicalSummary" class="content-area">
        <div class="content-header">
          <h2><i class="fas fa-clipboard-list"></i> Résumé Médical</h2>
          <p id="currentPatientNameDisplay3" class="text-gray"></p>
        </div>
        <div class="glass p-6 rounded-xl shadow hover-lift">
          <form onsubmit="event.preventDefault(); saveConsultation();">
            <div class="form-group mb-6">
              <label>Type de maladie *</label>
              <input type="text" id="diseaseType" class="form-control uppercase-input" required />
            </div>
          
            <div class="form-group mb-6">
              <label>Observations utiles</label>
              <textarea id="summaryText" class="form-control" rows="3" placeholder="Notes additionnelles sur l'état du patient..."></textarea>
            </div>
          
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Nom du soignant *</label>
                <input type="text" id="doctorName" class="form-control" required readonly />
              </div>
              <div class="form-group">
                <label>Contact du soignant</label>
                <input type="text" id="doctorContact" class="form-control" />
              </div>
            </div>
          
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
  <label>Service (Consultation)</label>
  <input type="text" id="doctorService" class="form-control" readonly />
</div>
              <div class="form-group">
                <label>Centre de consultation *</label>
                <input type="text" id="consultationCenter" class="form-control" required />
              </div>
            </div>
          
            <div class="flex gap-3 mt-4">
              <button type="submit" class="btn btn-primary animate-glow">
                <i class="fas fa-save"></i> Enregistrer Consultation
              </button>
              <button type="button" class="btn btn-outline" onclick="showSection('prescriptionEditor')">
                <i class="fas fa-arrow-left"></i> Retour
              </button>
            </div>
          </form>
        </div>
      </div>
      <!-- Old Consultation -->
      <div id="oldConsultation" class="content-area">
  <div class="content-header">
    <h2><i class="fas fa-history"></i> Ancienne Consultation</h2>
    <p>Service : <span id="listServiceDisplay" class="font-bold text-primary"></span></p>
  </div>

  <div class="filters-container mb-6 animate-slideIn">
    <div class="form-group">
      <label><i class="fas fa-search"></i> Rechercher un patient (nom, ID, téléphone)</label>
      <input type="text" id="searchInput" class="form-control" oninput="debouncedSearch()"
             placeholder="Entrez au moins 2 caractères..." />
    </div>
  </div>

  <div id="searchLoader" class="hidden text-center">
    <div class="loading-spinner"></div>
    <p class="text-gray mt-2">Recherche en cours...</p>
  </div>

  <div id="patientsListContainer" class="patients-list-container">
    <div id="patientListContent"></div>
  </div>

  <div id="noResults" class="hidden text-center py-12">
    <i class="fas fa-user-md text-5xl text-gray-300 mb-4 animate-float"></i>
    <h3 class="text-xl font-semibold text-gray-600 mb-2">Aucun patient trouvé</h3>
    <p class="text-gray-500">Aucun patient ne correspond à votre recherche dans ce service.</p>
  </div>
</div>
      <!-- Registry -->
      <div id="registry" class="content-area">
        <div class="content-header">
          <h2><i class="fas fa-chart-bar"></i> Registre & Statistiques</h2>
          <p>Filtrez et analysez les données médicales</p>
        </div>
      
        <div class="filters-container animate-slideIn">
          <div class="filters-grid">
            <div class="form-group">
              <label><i class="fas fa-disease"></i> Maladie</label>
              <input type="text" id="diseaseSearchInput" class="form-control" oninput="debouncedUpdateStats()" placeholder="Rechercher..." />
            </div>
            <div class="form-group">
              <label><i class="fas fa-calendar-alt"></i> Date de début</label>
              <input type="date" id="dateFilterStart" class="form-control" oninput="debouncedUpdateStats()" />
            </div>
            <div class="form-group">
              <label><i class="fas fa-calendar-alt"></i> Date de fin</label>
              <input type="date" id="dateFilterEnd" class="form-control" oninput="debouncedUpdateStats()" />
            </div>
            <div class="form-group">
              <label><i class="fas fa-hospital"></i> Centre</label>
              <select id="centerFilter" class="form-control" oninput="debouncedUpdateStats()">
                <option value="all">Tous les centres</option>
              </select>
            </div>
            <div class="form-group">
              <label><i class="fas fa-stethoscope"></i> Service</label>
              <select id="serviceFilter" class="form-control" oninput="debouncedUpdateStats()"></select>
            </div>
            <div class="form-group flex items-end">
              <button class="btn btn-primary w-full" onclick="exportData()">
                <i class="fas fa-file-csv"></i> Exporter CSV
              </button>
            </div>
          </div>
        </div>
      
        <div class="stats-grid my-6">
          <div class="stat-card hover-lift">
            <div class="stat-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-label">Patients uniques</div>
            <div class="stat-value" id="totalPatients">0</div>
          </div>
          <div class="stat-card hover-lift">
            <div class="stat-icon">
              <i class="fas fa-file-medical"></i>
            </div>
            <div class="stat-label">Total consultations</div>
            <div class="stat-value" id="totalConsultations">0</div>
          </div>
          <div class="stat-card hover-lift">
            <div class="stat-icon">
              <i class="fas fa-ambulance"></i>
            </div>
            <div class="stat-label">Consultations aux urgences</div>
            <div class="stat-value" id="urgencesCount">0</div>
          </div>
          <div class="stat-card hover-lift">
            <div class="stat-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-label">Maladies distinctes</div>
            <div class="stat-value" id="diseaseCount">0</div>
          </div>
        </div>
      
        <div class="glass p-6 rounded-xl shadow hover-lift">
          <h3 class="font-bold text-xl mb-4 flex items-center gap-2">
            <i class="fas fa-ranking-star text-primary animate-pulse"></i>
            Top 10 Maladies
          </h3>
          <div id="diseaseStats" class="disease-stats-table"></div>
        </div>
      </div>
      <!-- Settings -->
      <div id="settings" class="content-area">
        <div id="settingsMenu" class="content-header">
          <h2><i class="fas fa-cog"></i> Paramètres</h2>
          <p>Gérez votre compte et vos préférences</p>
          <div class="flex gap-3 mt-4 flex-wrap">
            <button class="btn btn-secondary" onclick="showSettingsSubSection('profileSection')">
              <i class="fas fa-user"></i> Profil
            </button>
            <button class="btn btn-secondary" onclick="showSettingsSubSection('passwordSection')">
              <i class="fas fa-lock"></i> Mot de passe
            </button>
            <button class="btn btn-outline" onclick="goBack()">
              <i class="fas fa-arrow-left"></i> Retour
            </button>
          </div>
        </div>
        <div id="profileSection" class="hidden">
          <div class="glass p-6 rounded-xl shadow hover-lift mt-4">
            <h3 class="font-bold text-xl mb-4">Modifier votre profil</h3>
            <form id="profileForm">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                  <label>Prénom</label>
                  <input type="text" id="editFirstName" class="form-control" disabled />
                </div>
                <div class="form-group">
                  <label>Nom</label>
                  <input type="text" id="editLastName" class="form-control" disabled />
                </div>
              </div>
            
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                  <label>Nom d'utilisateur</label>
                  <input type="text" id="editUsername" class="form-control" disabled />
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" id="editEmail" class="form-control" required />
                </div>
              </div>
            
              <div class="form-group mb-6">
                <label>Téléphone</label>
                <input type="text" id="editPhone" class="form-control" />
              </div>
            
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                  <label>Rôle</label>
                  <input type="text" id="editRole" class="form-control" disabled />
                </div>
                <div class="form-group">
                  <label>Service</label>
                  <input type="text" id="editService" class="form-control" disabled />
                </div>
              </div>
            
              <div id="profileAlert"></div>
              <div class="flex gap-3">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> Mettre à jour
                </button>
                <button type="button" class="btn btn-outline" onclick="showSettingsSubSection('')">
                  <i class="fas fa-times"></i> Annuler
                </button>
              </div>
            </form>
          </div>
        </div>
        <div id="passwordSection" class="hidden">
          <div class="glass p-6 rounded-xl shadow hover-lift mt-4">
            <h3 class="font-bold text-xl mb-4">Changer le mot de passe</h3>
            <form id="passwordForm">
              <div class="form-group mb-6">
                <label>Ancien mot de passe</label>
                <input type="password" id="oldPassword" class="form-control" required />
              </div>
            
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                  <label>Nouveau mot de passe</label>
                  <input type="password" id="newPassword" class="form-control" required minlength="6" />
                </div>
                <div class="form-group">
                  <label>Confirmer</label>
                  <input type="password" id="confirmNewPassword" class="form-control" required />
                </div>
              </div>
            
              <div id="securityAlert"></div>
              <div class="flex gap-3">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-key"></i> Changer le mot de passe
                </button>
                <button type="button" class="btn btn-outline" onclick="showSettingsSubSection('')">
                  <i class="fas fa-times"></i> Annuler
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="app-footer">
      <p><i class="fas fa-heartbeat text-primary"></i> MediTrack Pro © 2025 — Système de gestion médicale sécurisé</p>
      <p class="text-sm mt-2 text-gray-500">Version 2.0 • <span id="currentYear"></span></p>
    </div>
  </div>
<!-- ... Le reste du HTML reste inchangé, je ne fournis que la partie <script> mise à jour à la fin du body. Remplacez l'ancien script par celui-ci. -->

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
<script>
// ======================== SUPABASE (sans conflit global) ========================
const { createClient } = supabase; // Récupère createClient depuis la globale du CDN
const supabaseUrl = 'https://huhckdnnekiglhwetili.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1aGNrZG5uZWtpZ2xod2V0aWxpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NTU3MjYsImV4cCI6MjA4MjIzMTcyNn0.tyFb-ICxAZmw8ktpzb8MPjw0Bwb5-2a82CCSYgS9QEU';
const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

let currentSupabaseUser = null;
let storedUser = null;
let patients = [];
let consultations = [];
let currentPatient = null;
let currentPrescription = '';
let currentSection = 'mainMenu';
// Liste des services
const servicesList = [
  'Administration','Anatomo-pathologie','Anesthésie-Réanimation','Cardiologie','Chirurgie générale',
  'Chirurgie pédiatrique','Chirurgie Viscérale','Consultation générale','Dermatologie','Gastroentérologie',
  'Gynécologie','Hématologie','Infertilité','Kinésithérapie','Laboratoire','Médecine Interne',
  'Néphrologie','Neurochirurgie','Neurologie','Odontologie/Stomatologie','Ophtalmologie',
  'Optométrie','ORL','Pédiatrie','Pneumologie','Psychiatrie','Radiologie/Imagerie médicale',
  'Réanimation médicale et polysalle','Rhumatologie','Sage-femme/Obstétrique','Scanner',
  'Traumatologie','Transfusion sanguine','Urgences','Urologie','Autre'
].sort();

// ======================== BASCULE INSCRIPTION / CONNEXION ========================
function toggleAuthView(view) {
  document.getElementById('authAlert').innerHTML = '';
  document.getElementById('registerView').classList.add('hidden');
  document.getElementById('loginView').classList.add('hidden');
  if (view === 'register') {
    document.getElementById('registerView').classList.remove('hidden');
  } else {
    document.getElementById('loginView').classList.remove('hidden');
  }
}

// ======================== NOTIFICATIONS ========================
function showNotification(message, type = 'success') {
  const container = document.getElementById('notificationContainer');
  const notif = document.createElement('div');
  notif.className = `notification ${type}`;
  notif.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i><span>${message}</span>`;
  container.appendChild(notif);
  setTimeout(() => { notif.style.opacity = '0'; setTimeout(() => notif.remove(), 300); }, 4000);
}

// ======================== AUTHENTIFICATION ========================
document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('userEmail').value.trim();
  const password = document.getElementById('userPassword').value;
  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) {
    showNotification('Erreur connexion : ' + error.message, 'error');
  } else {
    currentSupabaseUser = data.user;
    await loadUserProfileAndStart();
  }
});

document.getElementById('registerForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('regEmail').value.trim();
  const password = document.getElementById('regPassword').value;
  const role = document.getElementById('regRole').value;
  const serviceSelect = document.getElementById('regService');
  const service = serviceSelect.value === 'Autre' ? document.getElementById('regOtherService').value.trim().toUpperCase() : serviceSelect.value;
  const { data, error } = await supabaseClient.auth.signUp({ email, password });
  if (error) {
    showNotification('Erreur inscription : ' + error.message, 'error');
  } else {
    showNotification('Inscription réussie ! Vous pouvez maintenant vous connecter.', 'success');
    if (data.user) {
      await supabaseClient.from('sante_utilisateur').insert({ user_id: data.user.id, role, service });
    }
    toggleAuthView('login');
  }
  e.target.reset();
});

async function loadUserProfileAndStart() {
  const { data: profile } = await supabaseClient
    .from('sante_utilisateur')
    .select('role, service')
    .eq('user_id', currentSupabaseUser.id)
    .single();
  storedUser = {
    role: profile?.role || 'Médecin',
    service: profile?.service || 'Consultation générale',
    email: currentSupabaseUser.email
  };
  await loadAllData();
  startApp();
}

async function loadAllData() {
  const { data: p } = await supabaseClient.from('sante_patient').select('*');
  patients = p || [];
  const { data: c } = await supabaseClient.from('sante_consultation').select('*');
  consultations = c || [];
}

// ======================== DÉMARRAGE APP ========================
function startApp() {
  document.getElementById('authScreen').classList.add('hidden');
  document.getElementById('appContainer').classList.remove('hidden');
  document.getElementById('currentUserInfo').textContent = `${storedUser.email} (${storedUser.role} - ${storedUser.service})`;
  document.getElementById('listServiceDisplay').textContent = storedUser.service;
  document.getElementById('currentYear').textContent = new Date().getFullYear();
  showMainMenu();
  populateServiceSelects();
  
  // NOUVEL AJOUT : Charger les données pour le registre
  loadRegistryData();

  showNotification('Bienvenue dans MediTrack Pro !', 'success');
}
function showMainMenu() {
  document.querySelectorAll('.content-area').forEach(s => s.classList.remove('active'));
  document.getElementById('mainMenu')?.classList.remove('hidden');
  document.getElementById('navControls')?.classList.add('hidden');
  document.getElementById('navBreadcrumb')?.classList.add('hidden');
}

function showSection(sectionId) {
  document.querySelectorAll('.content-area').forEach(s => s.classList.remove('active'));
  document.getElementById('mainMenu')?.classList.add('hidden');
  const target = document.getElementById(sectionId);
  if (target) target.classList.add('active');
  currentSection = sectionId;
  if (sectionId === 'prescriptionEditor' && currentPatient) loadPrescriptionTemplate();
}

// ======================== NOUVELLE CONSULTATION ========================
document.getElementById('newPatientForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const prenom = document.getElementById('patientPrenom').value.trim().toUpperCase();
  const nom = document.getElementById('patientNom').value.trim().toUpperCase();
  const age = document.getElementById('patientAge').value.trim() || null; // Envoie age directement (string ou number)
  const sexe = document.getElementById('patientGender').value;
  const telephone = document.getElementById('patientPhone').value || null;
  const adresse = document.getElementById('patientAddress').value || null;
  const groupe_sanguin = document.getElementById('patientBloodGroup').value.toUpperCase() || null;
  const rhesus = document.getElementById('patientRhesus').value || null;
  const service = document.getElementById('serviceType').value === 'Autre'
    ? document.getElementById('otherServiceNew').value.trim().toUpperCase()
    : document.getElementById('serviceType').value;
  const { data, error } = await supabaseClient
    .from('sante_patient')
    .insert([{
      prenom: prenom,
      nom: nom,
      age: age,
      sexe: sexe,
      telephone: telephone,
      adresse: adresse,
      groupe_sanguin: groupe_sanguin,
      rhesus: rhesus,
      service: service
    }])
    .select();
  if (error) {
    showNotification('Erreur : ' + error.message, 'error');
    console.error(error);
  } else {
    currentPatient = data[0];
    // Affichage du nom complet dans l'app (prénom + nom)
    const nomComplet = `${currentPatient.prenom} ${currentPatient.nom}`;
    document.getElementById('currentPatientNameDisplay2').textContent = nomComplet;
    document.getElementById('currentPatientNameDisplay3').textContent = nomComplet;
    showNotification('Patient créé avec succès !', 'success');
    showSection('prescriptionEditor');
  }
  e.target.reset();
});

// ======================== PRESCRIPTION ========================
function loadPrescriptionTemplate() {
  if (!currentPatient) return;
  const template = `=== CONSULTATION ===
Patient: ${currentPatient.nom} Âge: ${currentPatient.age || 'N/A'} Sexe: ${currentPatient.sexe === 'M' ? 'Masculin' : 'Féminin'}
Groupe sanguin: ${currentPatient.groupe_sanguin || ''}${currentPatient.rhesus || ''}
Tableau:
+---------------+---------------+---------------+
| Symptômes | Diagnostic | Traitement |
+---------------+---------------+---------------+
| ... | ... | ... |
+---------------+---------------+---------------+
Observations: `;
  document.getElementById('prescriptionContent').value = template;
  document.getElementById('prescriptionHeader').innerHTML = `
    <p><strong>Patient :</strong> ${currentPatient.nom}</p>
    <p><strong>Âge :</strong> ${currentPatient.age || 'N/A'}</p>
    <p><strong>Sexe :</strong> ${currentPatient.sexe === 'M' ? 'Masculin' : 'Féminin'}</p>
    <p><strong>Groupe sanguin :</strong> ${currentPatient.groupe_sanguin || ''}${currentPatient.rhesus || ''}</p>
    <p><strong>Soignant :</strong> ${storedUser.email}</p>
    <p><strong>Service :</strong> ${storedUser.service}</p>
  `;
}

// Passer au résumé
document.querySelector('#prescriptionForm button[type="submit"]')?.addEventListener('click', (e) => {
  e.preventDefault();
  currentPrescription = document.getElementById('prescriptionContent').value;
  document.getElementById('currentPatientNameDisplay3').textContent = `${currentPatient.nom} (ID: ${currentPatient.id})`;
  document.getElementById('doctorName').value = storedUser.email;
  document.getElementById('doctorService').value = storedUser.service;
  showSection('medicalSummary');
});

// Sauvegarde consultation
function saveConsultation() {
  const diseaseType = document.getElementById('diseaseType').value.trim().toUpperCase();
  const center = document.getElementById('consultationCenter').value.trim();
  if (!diseaseType || !center) {
    showNotification('Veuillez remplir le type de maladie et le centre', 'error');
    return;
  }
  supabaseClient.from('sante_consultation').insert([{
    symptomes: currentPrescription,
    diagnostic: diseaseType,
    patient_id: currentPatient.id,
    center: center,
    service: storedUser.service,
    date: new Date().toISOString().split('T')[0] // Format date simple : YYYY-MM-DD
  }]).then(({ error }) => {
    if (error) {
      showNotification('Erreur : ' + error.message, 'error');
      console.error(error);
    } else {
      showNotification('Consultation enregistrée avec succès !', 'success');
      currentPatient = null;
      currentPrescription = '';
      // NOUVEL AJOUT : Rafraîchir le registre après sauvegarde
      loadRegistryData(true); // true pour forcer rechargement depuis Supabase
      showMainMenu();
    }
  });
}
// Outils
function addTable() {
  const ta = document.getElementById('prescriptionContent');
  if (ta) ta.value += '\n+---------------+---------------+---------------+\n| | | |\n+---------------+---------------+---------------+\n';
}

function addSection() {
  const ta = document.getElementById('prescriptionContent');
  const title = prompt('Titre de la section');
  if (title && ta) ta.value += `\n\n=== ${title.toUpperCase()} ===\n\n`;
}

function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text(document.getElementById('prescriptionContent')?.value || '', 10, 10);
  doc.save('prescription.pdf');
}

// **FIX pour l'export Word : Ajout de try-catch pour debug, et assurance que docx est chargé. Si ça ne marche pas, vérifiez la console du navigateur pour erreurs.**
async function exportToWord() {
  try {
    if (!window.docx) {
      showNotification('Erreur : La bibliothèque docx.js n\'est pas chargée. Vérifiez votre connexion.', 'error');
      return;
    }
    const content = document.getElementById('prescriptionContent').value || 'Aucun contenu';
    const doc = new window.docx.Document({
      sections: [{
        properties: {},
        children: [
          new window.docx.Paragraph({
            children: [new window.docx.TextRun(content)],
          }),
        ],
      }],
    });
    const blob = await window.docx.Packer.toBlob(doc);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'prescription.docx';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotification('Export Word réussi !', 'success');
  } catch (error) {
    console.error('Erreur export Word:', error);
    showNotification('Erreur lors de l\'export Word : ' + error.message, 'error');
  }
}

// Services
function populateServiceSelects() {
  ['regService', 'serviceType', 'serviceFilter'].forEach(id => {
    const sel = document.getElementById(id);
    if (sel) sel.innerHTML = servicesList.map(s => `<option value="${s}">${s}</option>`).join('');
  });
}

// Déconnexion
function clearAuthData() {
  supabaseClient.auth.signOut().then(() => location.reload());
}

// Vérification session
async function checkAuth() {
  const { data: { session } } = await supabaseClient.auth.getSession()
  if (session) {
    currentSupabaseUser = session.user;
    await loadUserProfileAndStart();
  } else {
    document.getElementById('authScreen').classList.remove('hidden');
    toggleAuthView('login');
  }
}

// ======================== FONCTIONS AJOUTÉES/MISES À JOUR POUR LA RECHERCHE DANS "ANCIENNE CONSULTATION" ========================
// Débouncer pour la recherche (évite trop d'appels API)
function debouncedSearch() {
  clearTimeout(window.searchTimeout);
  window.searchTimeout = setTimeout(searchPatients, 300);
}

// Recherche patients avec support ID (si query est numérique), nom, prénom, téléphone. Interopérabilité avec Supabase pour récupération immédiate.
async function searchPatients() {
  const query = document.getElementById('searchInput').value.trim().toLowerCase();
  if (query.length < 2) {
    document.getElementById('patientListContent').innerHTML = '';
    return;
  }
  document.getElementById('searchLoader').classList.remove('hidden');
  document.getElementById('patientsListContainer').classList.add('hidden');
  document.getElementById('noResults').classList.add('hidden');

  let supabaseQuery = supabaseClient.from('sante_patient').select('*');
  
  // Si query est un nombre, recherche par ID exact
  if (!isNaN(query)) {
    supabaseQuery = supabaseQuery.eq('id', parseInt(query));
  } else {
    // Sinon, recherche par nom, prénom ou téléphone (insensible à la casse avec ilike)
    supabaseQuery = supabaseQuery.or(`nom.ilike.%${query}%,prenom.ilike.%${query}%,telephone.ilike.%${query}%`);
  }

  const { data: patients, error } = await supabaseQuery.order('nom', { ascending: true });

  document.getElementById('searchLoader').classList.add('hidden');

  if (error) {
    showNotification('Erreur de recherche : ' + error.message, 'error');
    console.error(error);
    return;
  }

  if (patients.length === 0) {
    document.getElementById('noResults').classList.remove('hidden');
    return;
  }

  document.getElementById('patientsListContainer').classList.remove('hidden');

  // Affichage des résultats avec toutes les infos du patient (interopérabilité : récupération complète des données stockées)
  const html = patients.map(p => `
    <div class="patient-search-card">
      <div class="patient-info">
        <h4>${p.prenom || ''} ${p.nom} (ID: ${p.id})</h4>
        <p>Âge: ${p.age || 'N/A'} ans | Sexe: ${p.sexe === 'M' ? 'Masculin' : 'Féminin'}</p>
        <p>Téléphone: ${p.telephone || 'N/A'} | Adresse: ${p.adresse || 'N/A'}</p>
        <p>Groupe sanguin: ${p.groupe_sanguin || 'N/A'}${p.rhesus || ''}</p>
        <p>Service: ${p.service || 'N/A'}</p>
      </div>
      <div class="patient-actions">
        <button class="btn btn-primary" onclick="continueWithPatient(${p.id})">
          <i class="fas fa-arrow-right"></i> Continuer la consultation
        </button>
      </div>
    </div>
  `).join('');
  document.getElementById('patientListContent').innerHTML = html;
}

// Continuer avec le patient : Récupère les données complètes du patient + consultations passées pour interopérabilité
async function continueWithPatient(id) {
  const { data: patientData, error: patientError } = await supabaseClient.from('sante_patient').select('*').eq('id', id).single();
  if (patientError) {
    showNotification('Erreur chargement patient : ' + patientError.message, 'error');
    console.error(patientError);
    return;
  }

  // Récupération des consultations passées pour ce patient (interopérabilité : échange de données entre tables)
  const { data: pastConsultations, error: consultError } = await supabaseClient
    .from('sante_consultation')
    .select('*')
    .eq('patient_id', id)
    .order('date', { ascending: false });

  if (consultError) {
    showNotification('Erreur chargement consultations passées : ' + consultError.message, 'error');
    console.error(consultError);
  }

  currentPatient = patientData;
  const nomComplet = `${currentPatient.prenom || ''} ${currentPatient.nom}`;
  document.getElementById('currentPatientNameDisplay2').textContent = nomComplet;
  document.getElementById('currentPatientNameDisplay3').textContent = nomComplet;

  // Chargement du template avec ajout des consultations passées pour continuité
  loadPrescriptionTemplate();

  // Ajout des consultations passées au template (pour continuer sur l'ancien)
  if (pastConsultations && pastConsultations.length > 0) {
    const ta = document.getElementById('prescriptionContent');
    ta.value += '\n\n=== CONSULTATIONS PASSÉES ===\n';
    pastConsultations.forEach(consult => {
      ta.value += `\nDate: ${consult.date}\nDiagnostic: ${consult.diagnostic}\nSymptômes: ${consult.symptomes}\nCentre: ${consult.center}\nService: ${consult.service}\n---\n`;
    });
    showNotification('Consultations passées chargées pour continuité.', 'success');
  } else {
    showNotification('Aucune consultation passée trouvée. Commencez une nouvelle.', 'info');
  }

  showSection('prescriptionEditor');
}

// Ajoutez ces fonctions si nécessaire pour les autres sections (registry, settings, etc.) - mais elles ne sont pas modifiées ici.
//
  // ======================== FONCTIONS POUR LA SECTION REGISTRE & STATISTIQUES ========================

let allConsultations = []; // Stockera toutes les consultations pour les stats
let allPatients = [];      // Stockera tous les patients pour éviter doublons

// Charger toutes les données nécessaires pour les stats (appelée au démarrage)
async function loadRegistryData() {
  const { data: patientsData, error: pError } = await supabaseClient.from('sante_patient').select('id');
  const { data: consultationsData, error: cError } = await supabaseClient
    .from('sante_consultation')
    .select('id, diagnostic, center, service, date, patient_id');

  if (pError || cError) {
    showNotification('Erreur chargement données registre', 'error');
    return;
  }

  allPatients = patientsData || [];
  allConsultations = consultationsData || [];

  // Centres uniques pour le filtre
  const centers = [...new Set(allConsultations.map(c => c.center).filter(Boolean))].sort();
  const centerSelect = document.getElementById('centerFilter');
  centerSelect.innerHTML = '<option value="all">Tous les centres</option>';
  centers.forEach(c => {
    centerSelect.innerHTML += `<option value="${c}">${c}</option>`;
  });

  // Services déjà remplis via populateServiceSelects()

  updateStats(); // Première mise à jour des stats
}

// Fonction principale de mise à jour des statistiques avec filtres
async function updateStats() {
  let filtered = allConsultations;

  // Filtre Maladie
  const diseaseQuery = document.getElementById('diseaseSearchInput').value.trim().toLowerCase();
  if (diseaseQuery) {
    filtered = filtered.filter(c => c.diagnostic?.toLowerCase().includes(diseaseQuery));
  }

  // Filtre Date début
  const startDate = document.getElementById('dateFilterStart').value;
  if (startDate) {
    filtered = filtered.filter(c => c.date >= startDate);
  }

  // Filtre Date fin
  const endDate = document.getElementById('dateFilterEnd').value;
  if (endDate) {
    filtered = filtered.filter(c => c.date <= endDate);
  }

  // Filtre Centre
  const center = document.getElementById('centerFilter').value;
  if (center && center !== 'all') {
    filtered = filtered.filter(c => c.center === center);
  }

  // Filtre Service
  const service = document.getElementById('serviceFilter').value;
  if (service && service !== '') {
    filtered = filtered.filter(c => c.service === service);
  }

  // Calcul des stats
  const patientIds = [...new Set(filtered.map(c => c.patient_id))];
  const uniquePatients = patientIds.length;

  const totalConsultations = filtered.length;

  const urgencesCount = filtered.filter(c => c.service?.toLowerCase().includes('urgence')).length;

  const diseases = filtered.map(c => c.diagnostic?.trim()).filter(Boolean);
  const uniqueDiseases = [...new Set(diseases)].length;

  // Mise à jour des cartes
  document.getElementById('totalPatients').textContent = uniquePatients;
  document.getElementById('totalConsultations').textContent = totalConsultations;
  document.getElementById('urgencesCount').textContent = urgencesCount;
  document.getElementById('diseaseCount').textContent = uniqueDiseases;

  // Top 10 Maladies
  const diseaseCountMap = {};
  diseases.forEach(d => {
    diseaseCountMap[d] = (diseaseCountMap[d] || 0) + 1;
  });

  const sortedDiseases = Object.entries(diseaseCountMap)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);

  let tableHTML = `
    <table style="width:100%; border-collapse: collapse; margin-top: 1rem;">
      <thead>
        <tr style="background: var(--primary-light);">
          <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--primary);">Rang</th>
          <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--primary);">Maladie</th>
          <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid var(--primary);">Nombre de cas</th>
        </tr>
      </thead>
      <tbody>
  `;

  if (sortedDiseases.length === 0) {
    tableHTML += `<tr><td colspan="3" style="text-align:center; padding:1.5rem; color:var(--gray);">Aucune donnée pour les filtres sélectionnés</td></tr>`;
  } else {
    sortedDiseases.forEach(([disease, count], index) => {
      tableHTML += `
        <tr style="border-bottom: 1px solid var(--gray-light);">
          <td style="padding: 0.75rem;">${index + 1}</td>
          <td style="padding: 0.75rem; font-weight: 600;">${disease}</td>
          <td style="padding: 0.75rem; text-align: center; color: var(--primary); font-weight: bold;">${count}</td>
        </tr>
      `;
    });
  }

  tableHTML += `</tbody></table>`;
  document.getElementById('diseaseStats').innerHTML = tableHTML;
}

// Débouncer pour éviter trop d'appels lors de la saisie
function debouncedUpdateStats() {
  clearTimeout(window.statsTimeout);
  window.statsTimeout = setTimeout(updateStats, 400);
}

// Export CSV des consultations filtrées
function exportData() {
  let filtered = allConsultations;

  // Appliquer les mêmes filtres que pour les stats
  const diseaseQuery = document.getElementById('diseaseSearchInput').value.trim().toLowerCase();
  if (diseaseQuery) filtered = filtered.filter(c => c.diagnostic?.toLowerCase().includes(diseaseQuery));

  const startDate = document.getElementById('dateFilterStart').value;
  if (startDate) filtered = filtered.filter(c => c.date >= startDate);

  const endDate = document.getElementById('dateFilterEnd').value;
  if (endDate) filtered = filtered.filter(c => c.date <= endDate);

  const center = document.getElementById('centerFilter').value;
  if (center && center !== 'all') filtered = filtered.filter(c => c.center === center);

  const service = document.getElementById('serviceFilter').value;
  if (service) filtered = filtered.filter(c => c.service === service);

  if (filtered.length === 0) {
    showNotification('Aucune donnée à exporter avec ces filtres', 'warning');
    return;
  }

  let csv = 'ID Consultation,Date,Patient ID,Maladie,Centre,Service\n';
  filtered.forEach(c => {
    csv += `${c.id},${c.date},${c.patient_id},"${c.diagnostic || ''}","${c.center || ''}","${c.service || ''}"\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `registre_medtrack_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showNotification('Export CSV réussi !', 'success');
}

// Amélioration pour rafraîchir à chaque chargement
async function loadRegistryData(forceRefresh = false) {
  if (forceRefresh) {
    // Recharger depuis Supabase pour stats fraîches
    const { data: patientsData, error: pError } = await supabaseClient.from('sante_patient').select('id');
    const { data: consultationsData, error: cError } = await supabaseClient
      .from('sante_consultation')
      .select('id, diagnostic, center, service, date, patient_id');

    if (pError || cError) {
      showNotification('Erreur chargement données registre', 'error');
      return;
    }

    allPatients = patientsData || [];
    allConsultations = consultationsData || [];
  }

  // Centres uniques
  const centers = [...new Set(allConsultations.map(c => c.center).filter(Boolean))].sort();
  const centerSelect = document.getElementById('centerFilter');
  centerSelect.innerHTML = '<option value="all">Tous les centres</option>' + centers.map(c => `<option value="${c}">${c}</option>`).join('');

  // Initialiser filtres pour tout inclure
  document.getElementById('serviceFilter').value = '';  // Tous services
  document.getElementById('centerFilter').value = 'all'; // Tous centres

  updateStats(); // Mise à jour immédiate
}
  // ======================== NAVIGATION ENTRE SECTIONS ========================
function showSection(sectionId) {
  // Cacher toutes les sections
  document.querySelectorAll('.content-area').forEach(section => {
    section.classList.remove('active');
  });
  
  // Cacher le menu principal
  document.getElementById('mainMenu')?.classList.add('hidden');
  
  // Afficher la section demandée
  const target = document.getElementById(sectionId);
  if (target) {
    target.classList.add('active');
  }
  
  // === AFFICHAGE DES BOUTONS RETOUR ET ACCUEIL ===
  document.getElementById('navControls')?.classList.remove('hidden');
  
  // Cas spécial : charger le modèle de prescription si on va dans l'éditeur
  if (sectionId === 'prescriptionEditor' && currentPatient) {
    loadPrescriptionTemplate();
  }
  
  currentSection = sectionId;
}
  function goBack() {
  // Retour simple : on revient au menu principal
  showMainMenu();
}
// Initialisation
window.onload = checkAuth;
</script>
</body>
</html>
     

