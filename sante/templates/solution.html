<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MediTrack Pro — Gestion Médicale Intelligente</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --primary-light: #eef2ff;
      --primary-gradient: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%);
      --secondary: #7209b7;
      --secondary-light: #f3e8ff;
      --secondary-gradient: linear-gradient(135deg, #7209b7 0%, #6a08a6 100%);
      --success: #4cc9f0;
      --success-light: #e6f7ff;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --danger: #e63946;
      --danger-light: #ffe6e9;
      --warning: #ffb703;
      --card-bg: #ffffff;
      --sidebar-bg: #f1f5f9;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 10px 30px rgba(67, 97, 238, 0.15);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.2s ease;
      --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      --radius: 16px;
      --radius-sm: 8px;
      --glass: rgba(255, 255, 255, 0.9);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
      color: var(--dark);
      overflow-x: hidden;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 20% 80%, rgba(67, 97, 238, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(114, 9, 183, 0.1) 0%, transparent 50%);
      z-index: -1;
    }
    /* Utilities */
    .hidden {
      display: none !important;
    }
   
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .justify-between { justify-content: space-between; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .gap-4 { gap: 1rem; }
    .gap-6 { gap: 1.5rem; }
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-5 { padding: 1.25rem; }
    .p-6 { padding: 1.5rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .rounded-lg { border-radius: var(--radius-sm); }
    .rounded-xl { border-radius: var(--radius); }
    .rounded-2xl { border-radius: 1.5rem; }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .font-bold { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .text-sm { font-size: 0.875rem; }
    .text-base { font-size: 1rem; }
    .text-lg { font-size: 1.125rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-3xl { font-size: 1.875rem; }
    .cursor-pointer { cursor: pointer; }
    .w-full { width: 100%; }
    .w-auto { width: auto; }
    .max-w-4xl { max-width: 80rem; }
    .overflow-auto { overflow: auto; }
    .transition-all { transition: var(--transition); }
    .relative { position: relative; }
    .absolute { position: absolute; }
    .mt-4 { margin-top: 1rem; }
    .mt-6 { margin-top: 1.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .my-6 { margin: 1.5rem 0; }
    .uppercase-input { text-transform: uppercase; }
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
   
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
   
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
   
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
   
    @keyframes ripple {
      0% { transform: scale(0); opacity: 0.5; }
      20% { transform: scale(25); opacity: 0.3; }
      100% { transform: scale(40); opacity: 0; }
    }
   
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
   
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(67, 97, 238, 0.5); }
      50% { box-shadow: 0 0 20px rgba(67, 97, 238, 0.8); }
    }
   
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
   
    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }
   
    @keyframes bounceIn {
      0% { opacity: 0; transform: scale(0.8); }
      70% { opacity: 1; transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }
    .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
    .animate-slideUp { animation: slideUp 0.5s ease-out; }
    .animate-slideDown { animation: slideDown 0.4s ease-out; }
    .animate-slideIn { animation: slideIn 0.4s ease-out; }
    .animate-pulse { animation: pulse 2s infinite; }
    .animate-glow { animation: glow 2s infinite; }
    .animate-float { animation: float 3s ease-in-out infinite; }
    .animate-bounceIn { animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
   
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
   
    .btn:hover::before {
      left: 100%;
    }
   
    .btn-primary {
      background: var(--primary-gradient);
      color: white;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    }
   
    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }
   
    .btn-secondary {
      background: var(--secondary-gradient);
      color: white;
      box-shadow: 0 4px 12px rgba(114, 9, 183, 0.3);
    }
   
    .btn-secondary:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(114, 9, 183, 0.25);
    }
   
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
   
    .btn-outline:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-3px);
    }
   
    .btn-glass {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--dark);
    }
   
    .btn-glass:hover {
      background: white;
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }
   
    .btn-back {
      background: var(--gray-light);
      color: var(--gray);
      padding: 0.6rem 1.2rem;
    }
   
    .btn-back:hover {
      background: #dee2e6;
      transform: translateX(-3px);
    }
   
    .btn-icon {
      padding: 0.6rem;
      border-radius: 50%;
      width: 2.5rem;
      height: 2.5rem;
    }
   
    .btn-shimmer {
      background: linear-gradient(90deg,
        var(--primary) 0%,
        #4cc9f0 25%,
        var(--primary) 50%,
        #4cc9f0 75%,
        var(--primary) 100%);
      background-size: 200% auto;
      animation: shimmer 3s infinite linear;
    }
    /* Alerts */
    .alert {
      padding: 0.875rem 1rem;
      border-radius: var(--radius-sm);
      margin: 1rem 0;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      animation: slideIn 0.4s ease-out;
      border-left: 4px solid;
      backdrop-filter: blur(10px);
    }
   
    .alert-success {
      background: linear-gradient(90deg, #d1e7dd, #c3e6cb);
      color: #0f5132;
      border-left-color: #198754;
    }
   
    .alert-error {
      background: linear-gradient(90deg, #f8d7da, #f5c6cb);
      color: #842029;
      border-left-color: #dc3545;
    }
   
    .alert-warning {
      background: linear-gradient(90deg, #fff3cd, #ffeaa7);
      color: #664d03;
      border-left-color: #ffc107;
    }
   
    .alert-info {
      background: linear-gradient(90deg, #cff4fc, #b8e6f9);
      color: #055160;
      border-left-color: #0dcaf0;
    }
    /* Form Controls */
    .form-group {
      margin-bottom: 1.25rem;
      position: relative;
    }
   
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--dark);
      font-size: 0.9rem;
    }
   
    .form-control {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      transition: var(--transition);
      background: white;
      backdrop-filter: blur(10px);
    }
   
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
      transform: translateY(-2px);
    }
   
    .form-control::placeholder {
      color: #a0aec0;
    }
   
    select.form-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 16px 12px;
      padding-right: 2.5rem;
      text-transform: none;
    }
    .uppercase-input { text-transform: uppercase; }
    /* Layout */
    #authScreen,
    #appContainer {
      width: 100%;
      display: flex;
      flex-direction: column;
      animation: fadeIn 0.6s ease-out;
    }
    /* Auth Screen */
    #authScreen {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
      min-height: 100vh;
      justify-content: center;
      padding: 2rem 1rem;
    }
   
    .auth-container {
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2.5rem;
      max-width: 500px;
      width: 100%;
      margin: 0 auto;
      animation: slideUp 0.5s ease-out;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
   
    .app-logo {
      text-align: center;
      margin-bottom: 2rem;
      animation: float 3s ease-in-out infinite;
    }
   
    .app-logo h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary);
    }
   
    .app-logo h1 .gradient-text {
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
   
    .app-logo p {
      color: var(--gray);
      font-size: 1rem;
    }
    /* Header */
    .app-header {
      background: var(--glass);
      padding: 1rem 2rem;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
      position: sticky;
      top: 0;
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }
   
    .logo {
      font-size: 1.75rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--primary);
    }
   
    .logo i {
      font-size: 1.5rem;
      animation: pulse 2s infinite;
      color: var(--primary);
    }
   
    .user-info {
      font-weight: 600;
      color: var(--gray);
      background: var(--primary-light);
      padding: 0.5rem 1rem;
      border-radius: 50px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      backdrop-filter: blur(10px);
    }
   
    .user-info i {
      color: var(--primary);
    }
    /* Navigation */
    .nav-breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      padding: 0.75rem 1.5rem;
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
   
    .breadcrumb-item {
      color: var(--gray);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition-fast);
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
    }
   
    .breadcrumb-item:hover {
      background: var(--primary-light);
      color: var(--primary);
    }
   
    .breadcrumb-item.active {
      color: var(--primary);
      font-weight: 600;
    }
   
    .breadcrumb-separator {
      color: #ced4da;
    }
   
    .nav-controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    /* Main Menu */
    #mainMenu {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
   
    .menu-card {
      background: var(--glass);
      border-radius: var(--radius);
      padding: 2rem 1.5rem;
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.3);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
   
    .menu-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--primary-gradient);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s ease;
    }
   
    .menu-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: var(--shadow-hover);
      border-color: var(--primary);
    }
   
    .menu-card:hover::before {
      transform: scaleX(1);
    }
   
    .menu-card i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--primary);
      animation: float 3s ease-in-out infinite;
    }
   
    .menu-card h3 {
      font-size: 1.375rem;
      margin-bottom: 0.75rem;
      color: var(--dark);
    }
   
    .menu-card p {
      color: var(--gray);
      font-size: 0.95rem;
      line-height: 1.5;
    }
    /* Content Areas */
    .content-area {
      display: none;
    }
   
    .content-area.active {
      display: block;
      animation: slideUp 0.5s ease-out;
    }
    .content-header {
      margin-bottom: 2rem;
      background: var(--glass);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
   
    .content-header h2 {
      font-size: 1.875rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
   
    .content-header p {
      color: var(--gray);
      font-size: 1rem;
    }
    /* Patient List */
    .patients-list-container {
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-top: 1rem;
      max-height: 500px;
      overflow-y: auto;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
   
    .patient-search-card {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--gray-light);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
    }
   
    .patient-search-card:hover {
      background: var(--primary-light);
      transform: translateX(5px);
      border-radius: var(--radius-sm);
    }
   
    .patient-search-card:last-child {
      border-bottom: none;
    }
   
    .patient-search-card .patient-info h4 {
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
      color: var(--dark);
    }
   
    .patient-search-card .patient-info p {
      color: var(--gray);
      font-size: 0.9rem;
    }
   
    .patient-search-card .patient-actions {
      display: flex;
      gap: 0.5rem;
    }
   
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--gray-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }
   
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Patient Details */
    #patientDetails {
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-top: 1.5rem;
      padding: 1.5rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
   
    .details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
   
    .detail-item {
      background: var(--primary-light);
      padding: 1rem;
      border-radius: var(--radius-sm);
      backdrop-filter: blur(10px);
    }
   
    .detail-item label {
      font-size: 0.85rem;
      color: var(--gray);
      margin-bottom: 0.25rem;
      display: block;
    }
   
    .detail-item p {
      font-weight: 600;
      color: var(--dark);
    }
   
    .details-section-header {
      margin: 1.5rem 0 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--primary);
      color: var(--primary);
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
   
    .consultation-item {
      background: var(--glass);
      padding: 1.25rem;
      border-radius: var(--radius-sm);
      margin-bottom: 1rem;
      border-left: 4px solid var(--primary);
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: var(--transition);
      backdrop-filter: blur(10px);
    }
   
    .consultation-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
   
    .consultation-item.other-service {
      border-left-color: var(--secondary);
      background: var(--secondary-light);
    }
   
    .consultation-item .consultation-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
   
    .consultation-item .consultation-date {
      font-weight: 600;
      color: var(--primary);
    }
   
    .consultation-item .consultation-service {
      background: var(--gray-light);
      color: var(--gray);
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.85rem;
    }
    /* Prescription Editor */
    #prescriptionContent {
      font-family: 'Courier New', 'Consolas', monospace;
      font-size: 1rem;
      min-height: 350px;
      padding: 1.25rem;
      border: 2px solid #e2e8f0;
      border-radius: var(--radius-sm);
      white-space: pre-wrap;
      word-wrap: break-word;
      resize: vertical;
      background: #f8f9fa;
      line-height: 1.5;
      transition: var(--transition);
      backdrop-filter: blur(10px);
    }
   
    #prescriptionContent:focus {
      border-color: var(--primary);
      background: white;
      transform: translateY(-2px);
    }
   
    .editor-toolbar {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    /* Registry Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2rem;
    }
   
    .stat-card {
      background: var(--glass);
      padding: 1.5rem;
      border-radius: var(--radius);
      text-align: center;
      box-shadow: var(--shadow);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
   
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }
   
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--primary-gradient);
    }
   
    .stat-icon {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: var(--primary);
      animation: float 3s ease-in-out infinite;
    }
   
    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary);
      margin: 0.5rem 0;
      line-height: 1;
    }
   
    .stat-label {
      color: var(--gray);
      font-size: 0.95rem;
    }
   
    .disease-stats-table {
      width: 100%;
      background: var(--glass);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
   
    .disease-stats-table pre {
      margin: 0;
      padding: 1.5rem;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      overflow-x: auto;
    }
    /* Filters */
    .filters-container {
      background: var(--glass);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
   
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }
    /* Footer */
    .app-footer {
      margin-top: auto;
      padding: 1.5rem 2rem;
      text-align: center;
      color: var(--gray);
      font-size: 0.9rem;
      background: var(--glass);
      border-top: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(20px);
    }
    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      max-width: 400px;
    }
   
    .notification.success {
      background: linear-gradient(135deg, #198754 0%, #146c43 100%);
    }
   
    .notification.error {
      background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%);
    }
   
    .notification.warning {
      background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
      color: #212529;
    }
    /* Progress Bar */
    .progress-bar {
      height: 4px;
      background: var(--primary-light);
      border-radius: 2px;
      overflow: hidden;
      margin: 1rem 0;
    }
   
    .progress-fill {
      height: 100%;
      background: var(--primary-gradient);
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    /* Responsive */
    @media (max-width: 1024px) {
      .filters-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
   
    @media (max-width: 768px) {
      .app-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
        padding: 1rem;
      }
      #mainMenu {
        grid-template-columns: 1fr;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .filters-grid {
        grid-template-columns: 1fr;
      }
      .details-grid {
        grid-template-columns: 1fr;
      }
      .auth-container {
        padding: 1.5rem;
      }
      .nav-breadcrumb {
        flex-wrap: wrap;
      }
    }
    @media (max-width: 480px) {
      .content-header h2 {
        font-size: 1.5rem;
      }
      .btn {
        padding: 0.625rem 1rem;
        font-size: 0.9rem;
      }
      .notification {
        left: 20px;
        right: 20px;
        max-width: none;
      }
    }
    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(241, 241, 241, 0.5);
      border-radius: 4px;
      backdrop-filter: blur(10px);
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(193, 193, 193, 0.7);
      border-radius: 4px;
      backdrop-filter: blur(10px);
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(161, 161, 161, 0.9);
    }
    /* Grid utilities */
    .grid {
      display: grid;
    }
    .grid-cols-1 {
      grid-template-columns: repeat(1, 1fr);
    }
    .grid-cols-2 {
      grid-template-columns: repeat(2, 1fr);
    }
   
    .min-w-\[200px\] {
      min-width: 200px;
    }
    /* Hover effects */
    .hover-lift {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .hover-lift:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }
    /* Glass effect */
    .glass {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body>
  <!-- Notification System -->
  <div id="notificationContainer"></div>
  <!-- Auth Screen -->
  <div id="authScreen" class="flex items-center justify-center">
    <div class="auth-container">
      <div class="app-logo">
        <h1><i class="fas fa-heartbeat"></i> <span class="gradient-text">MediTrack Pro</span></h1>
        <p>Système de gestion médicale intelligent et sécurisé</p>
      </div>
      <div id="registerView" class="hidden">
        <h2 class="text-2xl font-bold mb-6 text-center">Créer un compte</h2>
        <form id="registerForm">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="form-group">
              <label>Prénom *</label>
              <input type="text" id="regFirstName" class="form-control uppercase-input" required />
            </div>
            <div class="form-group">
              <label>Nom *</label>
              <input type="text" id="regLastName" class="form-control uppercase-input" required />
            </div>
          </div>
         
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="form-group">
              <label>Nom d'utilisateur *</label>
              <input type="text" id="regUsername" class="form-control" required />
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="regEmail" class="form-control" required />
            </div>
          </div>
         
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="form-group">
              <label>Téléphone</label>
              <input type="text" id="regPhone" class="form-control" />
            </div>
            <div class="form-group">
              <label>Rôle *</label>
              <select id="regRole" class="form-control">
                <option>Professeur</option>
                <option>Médecin</option>
                <option>Infirmier(ère)</option>
                <option>TSO</option>
                <option>TAR</option>
                <option>TRIM</option>
                <option>Sage-femme</option>
                <option>Orthophoniste</option>
                <option>Kiné</option>
                <option>Opticien</option>
                <option>Administrateur</option>
              </select>
            </div>
          </div>
         
          <div class="form-group mb-4">
            <label>Service *</label>
            <select id="regService" class="form-control">
            </select>
            <div id="otherServiceGroup" class="form-group hidden mt-2">
              <label>Précisez le service *</label>
              <input type="text" id="regOtherService" class="form-control uppercase-input" />
            </div>
          </div>
         
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="form-group">
              <label>Mot de passe *</label>
              <input type="password" id="regPassword" class="form-control" required minlength="6" />
            </div>
            <div class="form-group">
              <label>Confirmer *</label>
              <input type="password" id="regConfirmPassword" class="form-control" required />
            </div>
          </div>
         
          <div id="authAlert"></div>
          <button type="submit" class="btn btn-primary w-full animate-pulse">
            <i class="fas fa-user-plus"></i> S'inscrire
          </button>
          <div class="text-center mt-4">
            <a href="#" onclick="toggleAuthView('login')" class="text-primary font-semibold hover:underline transition-all">
              <i class="fas fa-sign-in-alt"></i> Déjà inscrit ? Se connecter
            </a>
          </div>
        </form>
      </div>
      <div id="loginView">
        <h2 class="text-2xl font-bold mb-6 text-center animate-bounceIn">Se connecter</h2>
        <form id="loginForm">
          <div class="form-group mb-4">
            <label>Email ou Nom d'utilisateur *</label>
            <input type="text" id="userEmail" class="form-control" required />
          </div>
          <div class="form-group mb-6">
            <label>Mot de passe *</label>
            <input type="password" id="userPassword" class="form-control" required />
          </div>
          <div id="authAlert"></div>
          <button type="submit" class="btn btn-primary w-full animate-pulse">
            <i class="fas fa-sign-in-alt"></i> Connexion
          </button>
          <div class="text-center mt-4">
            <a href="#" onclick="toggleAuthView('register')" class="text-primary font-semibold hover:underline transition-all">
              <i class="fas fa-user-plus"></i> Pas encore de compte ? S'inscrire
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- App Container -->
  <div id="appContainer" class="hidden flex-col">
    <div class="app-header animate-slideDown">
      <div class="logo">
        <i class="fas fa-heartbeat"></i>
        <span>MediTrack Pro</span>
      </div>
      <div class="user-info" id="currentUserInfo"></div>
    </div>
    <div class="p-6 flex-1">
      <!-- Navigation Breadcrumb -->
      <div id="navBreadcrumb" class="nav-breadcrumb hidden">
        <div id="breadcrumbContent"></div>
      </div>
      <!-- Navigation Controls -->
      <div id="navControls" class="nav-controls hidden">
        <button class="btn btn-back" onclick="goBack()">
          <i class="fas fa-arrow-left"></i> Retour
        </button>
        <button class="btn btn-outline" onclick="showMainMenu()">
          <i class="fas fa-home"></i> Accueil
        </button>
      </div>
      <!-- Main Menu -->
      <div id="mainMenu">
        <div class="menu-card animate-bounceIn" onclick="showSection('newConsultation')">
          <i class="fas fa-user-plus"></i>
          <h3>Nouvelle Consultation</h3>
          <p>Créer un dossier patient</p>
        </div>
        <div class="menu-card animate-bounceIn" style="animation-delay: 0.1s" onclick="showSection('oldConsultation')">
          <i class="fas fa-history"></i>
          <h3>Ancienne Consultation</h3>
          <p>Rechercher un patient</p>
        </div>
        <div class="menu-card animate-bounceIn" style="animation-delay: 0.2s" onclick="showSection('registry')">
          <i class="fas fa-chart-bar"></i>
          <h3>Registre & Statistiques</h3>
          <p>Données agrégées</p>
        </div>
        <div class="menu-card animate-bounceIn" style="animation-delay: 0.3s" onclick="showSection('settings')">
          <i class="fas fa-cog"></i>
          <h3>Paramètres</h3>
          <p>Gérer votre profil</p>
        </div>
        <div class="menu-card animate-bounceIn" style="animation-delay: 0.4s" onclick="clearAuthData()">
          <i class="fas fa-sign-out-alt"></i>
          <h3>Déconnexion</h3>
          <p>Quitter la session</p>
        </div>
      </div>
      <!-- New Consultation -->
      <div id="newConsultation" class="content-area">
        <div class="content-header">
          <h2><i class="fas fa-user-plus"></i> Nouvelle Consultation</h2>
          <p>Créez un nouveau dossier patient</p>
        </div>
        <div class="glass p-6 rounded-xl shadow hover-lift">
          <form id="newPatientForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Nom complet du patient *</label>
                <input type="text" id="patientName" class="form-control uppercase-input" required />
              </div>
              <div class="form-group">
                <label>Âge *</label>
                <input type="text" id="patientAge" class="form-control" required placeholder="Ex: 0.5 pour 6 mois ou <1 pour <1 an" />
              </div>
            </div>
           
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Sexe *</label>
                <select id="patientGender" class="form-control" required>
                  <option value="M">Masculin</option>
                  <option value="F">Féminin</option>
                </select>
              </div>
              <div class="form-group">
                <label>Profession</label>
                <input type="text" id="patientProfession" class="form-control" />
              </div>
            </div>
           
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Téléphone</label>
                <input type="text" id="patientPhone" class="form-control" />
              </div>
              <div class="form-group">
                <label>Adresse</label>
                <input type="text" id="patientAddress" class="form-control" />
              </div>
            </div>
           
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Groupe sanguin *</label>
                <input type="text" id="patientBloodGroup" class="form-control uppercase-input" required placeholder="Ex: A, B, AB, O" />
              </div>
              <div class="form-group">
                <label>Rhésus *</label>
                <select id="patientRhesus" class="form-control" required>
                  <option value="+">+</option>
                  <option value="-">-</option>
                </select>
              </div>
            </div>
           
            <div class="form-group mb-6">
              <label>Service d'enregistrement initial *</label>
              <select id="serviceType" class="form-control" required>
              </select>
              <div id="otherServiceGroupNew" class="form-group hidden mt-2">
                <label>Précisez le service *</label>
                <input type="text" id="otherServiceNew" class="form-control uppercase-input" />
              </div>
            </div>
           
            <div id="newConsultAlert"></div>
            <div class="flex gap-4">
              <button type="submit" class="btn btn-primary animate-glow">
                <i class="fas fa-arrow-right"></i> Continuer vers la prescription
              </button>
              <button type="button" class="btn btn-outline" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Retour
              </button>
            </div>
          </form>
        </div>
      </div>
      <!-- Prescription Editor -->
      <div id="prescriptionEditor" class="content-area">
        <div class="content-header">
          <h2><i class="fas fa-file-medical"></i> Éditeur de Prescription</h2>
          <p id="currentPatientNameDisplay2" class="text-gray"></p>
        </div>
        <div id="prescriptionHeader" class="mb-4 p-4 bg-light rounded border"></div>
        <div class="glass p-6 rounded-xl shadow hover-lift">
          <div class="editor-toolbar">
            <button class="btn btn-secondary animate-pulse" onclick="addSection()">
              <i class="fas fa-plus"></i> Ajouter Section
            </button>
            <button class="btn btn-secondary animate-pulse" onclick="addTable()">
              <i class="fas fa-table"></i> Ajouter Tableau
            </button>
            <button class="btn btn-outline" onclick="showSection('newConsultation')">
              <i class="fas fa-edit"></i> Modifier Patient
            </button>
            <button class="btn btn-primary" onclick="exportToPDF()">
              <i class="fas fa-file-pdf"></i> Exporter en PDF
            </button>
            <button class="btn btn-primary" onclick="exportToWord()">
              <i class="fas fa-file-word"></i> Exporter en Word
            </button>
          </div>
         
          <form id="prescriptionForm">
            <textarea id="prescriptionContent" class="w-full" placeholder="Commencez à rédiger la prescription ici..."></textarea>
            <div id="editorAlert" class="mt-3"></div>
            <div class="flex gap-3 mt-4">
              <button type="submit" class="btn btn-primary btn-shimmer">
                <i class="fas fa-arrow-right"></i> Suivant : Résumé Médical
              </button>
              <button type="button" class="btn btn-outline" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Retour
              </button>
            </div>
          </form>
        </div>
      </div>
      <!-- Medical Summary -->
      <div id="medicalSummary" class="content-area">
        <div class="content-header">
          <h2><i class="fas fa-clipboard-list"></i> Résumé Médical</h2>
          <p id="currentPatientNameDisplay3" class="text-gray"></p>
        </div>
        <div class="glass p-6 rounded-xl shadow hover-lift">
          <form onsubmit="event.preventDefault(); saveConsultation();">
            <div class="form-group mb-6">
              <label>Type de maladie *</label>
              <input type="text" id="diseaseType" class="form-control uppercase-input" required />
            </div>
           
            <div class="form-group mb-6">
              <label>Observations utiles</label>
              <textarea id="summaryText" class="form-control" rows="3" placeholder="Notes additionnelles sur l'état du patient..."></textarea>
            </div>
           
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Nom du soignant *</label>
                <input type="text" id="doctorName" class="form-control" required readonly />
              </div>
              <div class="form-group">
                <label>Contact du soignant</label>
                <input type="text" id="doctorContact" class="form-control" />
              </div>
            </div>
           
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label>Service (Consultation) *</label>
                <input type="text" id="doctorService" class="form-control" required readonly />
              </div>
              <div class="form-group">
                <label>Centre de consultation *</label>
                <input type="text" id="consultationCenter" class="form-control" required />
              </div>
            </div>
           
            <div class="flex gap-3 mt-4">
              <button type="submit" class="btn btn-primary animate-glow">
                <i class="fas fa-save"></i> Enregistrer Consultation
              </button>
              <button type="button" class="btn btn-outline" onclick="showSection('prescriptionEditor')">
                <i class="fas fa-arrow-left"></i> Retour
              </button>
            </div>
          </form>
        </div>
      </div>
      <!-- Old Consultation -->
      <div id="oldConsultation" class="content-area">
        <div class="content-header">
          <h2><i class="fas fa-history"></i> Ancienne Consultation</h2>
          <p>Service : <span id="listServiceDisplay" class="font-bold text-primary"></span></p>
        </div>
       
        <div class="filters-container mb-6 animate-slideIn">
          <div class="form-group">
            <label><i class="fas fa-search"></i> Rechercher un patient (nom, ID, téléphone)</label>
            <input type="text" id="searchInput" class="form-control" oninput="debouncedSearch()"
                   placeholder="Entrez au moins 2 caractères..." />
          </div>
        </div>
       
        <div id="searchLoader" class="hidden text-center">
          <div class="loading-spinner"></div>
          <p class="text-gray mt-2">Recherche en cours...</p>
        </div>
       
        <div id="patientsListContainer" class="hidden">
          <div id="patientListContent"></div>
        </div>
       
        <div id="patientDetails" class="hidden"></div>
       
        <div id="noResults" class="hidden text-center py-12">
          <i class="fas fa-user-md text-5xl text-gray-300 mb-4 animate-float"></i>
          <h3 class="text-xl font-semibold text-gray-600 mb-2">Aucun patient trouvé</h3>
          <p class="text-gray-500">Aucun patient ne correspond à votre recherche dans ce service.</p>
        </div>
      </div>
      <!-- Registry -->
      <div id="registry" class="content-area">
        <div class="content-header">
          <h2><i class="fas fa-chart-bar"></i> Registre & Statistiques</h2>
          <p>Filtrez et analysez les données médicales</p>
        </div>
       
        <div class="filters-container animate-slideIn">
          <div class="filters-grid">
            <div class="form-group">
              <label><i class="fas fa-disease"></i> Maladie</label>
              <input type="text" id="diseaseSearchInput" class="form-control" oninput="debouncedUpdateStats()" placeholder="Rechercher..." />
            </div>
            <div class="form-group">
              <label><i class="fas fa-calendar-alt"></i> Date de début</label>
              <input type="date" id="dateFilterStart" class="form-control" oninput="debouncedUpdateStats()" />
            </div>
            <div class="form-group">
              <label><i class="fas fa-calendar-alt"></i> Date de fin</label>
              <input type="date" id="dateFilterEnd" class="form-control" oninput="debouncedUpdateStats()" />
            </div>
            <div class="form-group">
              <label><i class="fas fa-hospital"></i> Centre</label>
              <select id="centerFilter" class="form-control" oninput="debouncedUpdateStats()">
                <option value="all">Tous les centres</option>
              </select>
            </div>
            <div class="form-group">
              <label><i class="fas fa-stethoscope"></i> Service</label>
              <select id="serviceFilter" class="form-control" oninput="debouncedUpdateStats()">
                <option value="all">Tous les services</option>
              </select>
            </div>
            <div class="form-group flex items-end">
              <button class="btn btn-primary w-full" onclick="exportData()">
                <i class="fas fa-file-csv"></i> Exporter CSV
              </button>
            </div>
          </div>
        </div>
       
        <div class="stats-grid my-6">
          <div class="stat-card hover-lift">
            <div class="stat-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-label">Patients uniques</div>
            <div class="stat-value" id="totalPatients">0</div>
          </div>
          <div class="stat-card hover-lift">
            <div class="stat-icon">
              <i class="fas fa-file-medical"></i>
            </div>
            <div class="stat-label">Total consultations</div>
            <div class="stat-value" id="totalConsultations">0</div>
          </div>
          <div class="stat-card hover-lift">
            <div class="stat-icon">
              <i class="fas fa-ambulance"></i>
            </div>
            <div class="stat-label">Consultations aux urgences</div>
            <div class="stat-value" id="urgencesCount">0</div>
          </div>
          <div class="stat-card hover-lift">
            <div class="stat-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-label">Maladies distinctes</div>
            <div class="stat-value" id="diseaseCount">0</div>
          </div>
        </div>
       
        <div class="glass p-6 rounded-xl shadow hover-lift">
          <h3 class="font-bold text-xl mb-4 flex items-center gap-2">
            <i class="fas fa-ranking-star text-primary animate-pulse"></i>
            Top 10 Maladies
          </h3>
          <div id="diseaseStats" class="disease-stats-table"></div>
        </div>
      </div>
      <!-- Settings -->
      <div id="settings" class="content-area">
        <div id="settingsMenu" class="content-header">
          <h2><i class="fas fa-cog"></i> Paramètres</h2>
          <p>Gérez votre compte et vos préférences</p>
          <div class="flex gap-3 mt-4 flex-wrap">
            <button class="btn btn-secondary" onclick="showSettingsSubSection('profileSection')">
              <i class="fas fa-user"></i> Profil
            </button>
            <button class="btn btn-secondary" onclick="showSettingsSubSection('passwordSection')">
              <i class="fas fa-lock"></i> Mot de passe
            </button>
            <button class="btn btn-outline" onclick="goBack()">
              <i class="fas fa-arrow-left"></i> Retour
            </button>
          </div>
        </div>
        <div id="profileSection" class="hidden">
          <div class="glass p-6 rounded-xl shadow hover-lift mt-4">
            <h3 class="font-bold text-xl mb-4">Modifier votre profil</h3>
            <form id="profileForm">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                  <label>Prénom</label>
                  <input type="text" id="editFirstName" class="form-control" disabled />
                </div>
                <div class="form-group">
                  <label>Nom</label>
                  <input type="text" id="editLastName" class="form-control" disabled />
                </div>
              </div>
             
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                  <label>Nom d'utilisateur</label>
                  <input type="text" id="editUsername" class="form-control" disabled />
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" id="editEmail" class="form-control" required />
                </div>
              </div>
             
              <div class="form-group mb-6">
                <label>Téléphone</label>
                <input type="text" id="editPhone" class="form-control" />
              </div>
             
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                  <label>Rôle</label>
                  <input type="text" id="editRole" class="form-control" disabled />
                </div>
                <div class="form-group">
                  <label>Service</label>
                  <input type="text" id="editService" class="form-control" disabled />
                </div>
              </div>
             
              <div id="profileAlert"></div>
              <div class="flex gap-3">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> Mettre à jour
                </button>
                <button type="button" class="btn btn-outline" onclick="showSettingsSubSection('')">
                  <i class="fas fa-times"></i> Annuler
                </button>
              </div>
            </form>
          </div>
        </div>
        <div id="passwordSection" class="hidden">
          <div class="glass p-6 rounded-xl shadow hover-lift mt-4">
            <h3 class="font-bold text-xl mb-4">Changer le mot de passe</h3>
            <form id="passwordForm">
              <div class="form-group mb-6">
                <label>Ancien mot de passe</label>
                <input type="password" id="oldPassword" class="form-control" required />
              </div>
             
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                  <label>Nouveau mot de passe</label>
                  <input type="password" id="newPassword" class="form-control" required minlength="6" />
                </div>
                <div class="form-group">
                  <label>Confirmer</label>
                  <input type="password" id="confirmNewPassword" class="form-control" required />
                </div>
              </div>
             
              <div id="securityAlert"></div>
              <div class="flex gap-3">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-key"></i> Changer le mot de passe
                </button>
                <button type="button" class="btn btn-outline" onclick="showSettingsSubSection('')">
                  <i class="fas fa-times"></i> Annuler
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="app-footer">
      <p><i class="fas fa-heartbeat text-primary"></i> MediTrack Pro &copy; 2025 — Système de gestion médicale sécurisé</p>
      <p class="text-sm mt-2 text-gray-500">Version 2.0 • <span id="currentYear"></span></p>
    </div>
  </div>
  <script>
    // ==================================
    // DONNÉES ET FONCTIONS PRINCIPALES
    // ==================================
    let patients = [];
    let consultations = [];
    let currentPatient = null;
    let currentPrescription = '';
    let storedUser = JSON.parse(localStorage.getItem('storedUser')) || null;
    let navigationHistory = [];
    let searchTimeout = null;
    let statsTimeout = null;
    let currentSection = 'mainMenu';
    const servicesList = [
      'Administration', 'Anatomo-pathologie', 'Anesthésie-Réanimation', 'Cardiologie', 'Chirurgie générale',
      'Chirurgie pédiatrique', 'Chirurgie Viscérale', 'Consultation générale', 'Dermatologie', 'Gastroentérologie',
      'Gynécologie', 'Hématologie', 'Infertilité', 'Kinésithérapie', 'Laboratoire', 'Médecine Interne', 'Néphrologie',
      'Neurochirurgie', 'Neurologie', 'Odontologie/Stomatologie', 'Ophtalmologie', 'Optométrie', 'ORL', 'Pédiatrie',
      'Pneumologie', 'Psychiatrie', 'Radiologie/Imagerie médicale', 'Réanimation médicale et polysalle', 'Rhumatologie',
      'Sage-femme/Obstétrique', 'Scanner', 'Traumatologie', 'Transfusion sanguine', 'Urgences', 'Urologie', 'Autre'
    ].sort(); // Tri alphabétique

    // Templates de prescription par service
    const prescriptionTemplates = {
      'Cardiologie': `=== CONSULTATION CARDIOLOGIE ===
Patient: [NOM] Âge: [AGE] Sexe: [SEXE]
Groupe sanguin: [GROUPE] Rhésus: [RHESUS]

Tableau:
+---------------+---------------+---------------+
| Symptômes     | Examens       | Traitement    |
+---------------+---------------+---------------+
| ...           | ...           | ...           |
+---------------+---------------+---------------+

Observations: `,
      'Ophtalmologie': `=== CONSULTATION OPHTALMOLOGIE ===
Patient: [NOM] Âge: [AGE] Sexe: [SEXE]
Groupe sanguin: [GROUPE] Rhésus: [RHESUS]

Tableau:
+---------------+---------------+---------------+
| Vision OD     | Vision OG     | Prescription  |
+---------------+---------------+---------------+
| ...           | ...           | ...           |
+---------------+---------------+---------------+

Observations: `,
      'Médecine Interne': `=== CONSULTATION MÉDECINE INTERNE ===
Patient: [NOM] Âge: [AGE] Sexe: [SEXE]
Groupe sanguin: [GROUPE] Rhésus: [RHESUS]

Tableau:
+---------------+---------------+---------------+
| Symptômes     | Diagnostic    | Traitement    |
+---------------+---------------+---------------+
| ...           | ...           | ...           |
+---------------+---------------+---------------+

Observations: `,
      'Urgences': `=== CONSULTATION URGENCES ===
Patient: [NOM] Âge: [AGE] Sexe: [SEXE]
Groupe sanguin: [GROUPE] Rhésus: [RHESUS]

Tableau:
+---------------+---------------+---------------+
| Urgence       | Intervention  | Suivi         |
+---------------+---------------+---------------+
| ...           | ...           | ...           |
+---------------+---------------+---------------+

Observations: `,
      'default': `=== CONSULTATION ===
Patient: [NOM] Âge: [AGE] Sexe: [SEXE]
Groupe sanguin: [GROUPE] Rhésus: [RHESUS]

Tableau:
+---------------+---------------+---------------+
| Symptômes     | Diagnostic    | Traitement    |
+---------------+---------------+---------------+
| ...           | ...           | ...           |
+---------------+---------------+---------------+

Observations: `
    };

    // ================================
    // FONCTIONS UTILITAIRES
    // ================================
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
        <span>${message}</span>
      `;
     
      const container = document.getElementById('notificationContainer');
      container.appendChild(notification);
     
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100px)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    function showAlert(elementId, message, type = 'info') {
      const alertDiv = document.getElementById(elementId);
      if (!alertDiv) return;
     
      alertDiv.innerHTML = `
        <div class="alert alert-${type}">
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
          ${message}
        </div>
      `;
    }
    function updateStoredUser(user) {
      storedUser = user;
      localStorage.setItem('storedUser', JSON.stringify(user));
    }
    // ================================
    // FONCTIONS D'AUTHENTIFICATION
    // ================================
    function showAuthScreen() {
      document.getElementById('appContainer').classList.add('hidden');
      document.getElementById('authScreen').classList.remove('hidden');
      if (storedUser) {
        toggleAuthView('login');
      } else {
        toggleAuthView('register');
      }
    }
   
    function toggleAuthView(view) {
      const authAlert = document.getElementById('authAlert');
      if (authAlert) authAlert.innerHTML = '';
     
      document.getElementById('registerView').classList.add('hidden');
      document.getElementById('loginView').classList.add('hidden');
     
      if (view === 'register') {
        document.getElementById('registerView').classList.remove('hidden');
      } else if (view === 'login') {
        document.getElementById('loginView').classList.remove('hidden');
      }
    }
   
    function clearAuthData() {
      localStorage.removeItem('isLoggedIn');
      navigationHistory = [];
      showAuthScreen();
      showNotification('Déconnexion réussie !', 'success');
    }
   
    function checkAuth() {
      if (localStorage.getItem('isLoggedIn') === 'true' && storedUser) {
        startApp();
      } else {
        showAuthScreen();
      }
    }
    // ================================
    // GESTION DES FORMULAIRES
    // ================================
    document.getElementById('loginForm').onsubmit = function(e) {
      e.preventDefault();
      const emailOrUsername = document.getElementById('userEmail').value;
      const password = document.getElementById('userPassword').value;
     
      if (storedUser &&
          (storedUser.email === emailOrUsername || storedUser.username === emailOrUsername) &&
          storedUser.password === password) {
        localStorage.setItem('isLoggedIn', 'true');
        showAlert('authAlert', 'Connexion réussie ! Redirection...', 'success');
        document.getElementById('loginForm').reset();
        setTimeout(startApp, 1000);
      } else {
        showAlert('authAlert', 'Identifiants incorrects. Veuillez vérifier vos informations ou vous inscrire.', 'error');
      }
    };
    document.getElementById('registerForm').onsubmit = function(e) {
      e.preventDefault();
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regConfirmPassword').value;
      const service = document.getElementById('regService').value === 'Autre' ? document.getElementById('regOtherService').value : document.getElementById('regService').value;
     
      if (password !== confirmPassword) {
        showAlert('authAlert', 'Le mot de passe et sa confirmation ne correspondent pas.', 'error');
        return;
      }
      if (password.length < 6) {
        showAlert('authAlert', 'Le mot de passe doit contenir au moins 6 caractères.', 'error');
        return;
      }
     
      const newUser = {
        firstName: document.getElementById('regFirstName').value,
        lastName: document.getElementById('regLastName').value,
        username: document.getElementById('regUsername').value,
        email: document.getElementById('regEmail').value,
        phone: document.getElementById('regPhone').value,
        role: document.getElementById('regRole').value,
        service: service,
        password: password,
      };
     
      updateStoredUser(newUser);
      showAlert('authAlert', 'Inscription réussie ! Veuillez vous connecter.', 'success');
      document.getElementById('registerForm').reset();
      toggleAuthView('login');
    };
    document.getElementById('profileForm').onsubmit = function(e) {
      e.preventDefault();
      const updatedUser = {
        ...storedUser,
        email: document.getElementById('editEmail').value,
        phone: document.getElementById('editPhone').value,
      };
      updateStoredUser(updatedUser);
      showAlert('profileAlert', 'Profil mis à jour !', 'success');
      document.getElementById('currentUserInfo').textContent = `${storedUser.firstName} ${storedUser.lastName} (${storedUser.role} - ${storedUser.service})`;
      setTimeout(() => showSettingsSubSection(''), 2000);
    };
    document.getElementById('passwordForm').onsubmit = function(e) {
      e.preventDefault();
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmNewPassword = document.getElementById('confirmNewPassword').value;
     
      if (!storedUser) {
        showAlert('securityAlert', 'Erreur utilisateur. Veuillez vous déconnecter et réessayer.', 'error');
        return;
      }
      if (oldPassword !== storedUser.password) {
        showAlert('securityAlert', 'L\'ancien mot de passe est incorrect.', 'error');
        return;
      }
      if (newPassword !== confirmNewPassword) {
        showAlert('securityAlert', 'Le nouveau mot de passe et sa confirmation ne correspondent pas.', 'error');
        return;
      }
      if (newPassword.length < 6) {
        showAlert('securityAlert', 'Le nouveau mot de passe doit contenir au moins 6 caractères.', 'error');
        return;
      }
     
      const updatedUser = { ...storedUser, password: newPassword };
      updateStoredUser(updatedUser);
      document.getElementById('passwordForm').reset();
      showAlert('securityAlert', 'Mot de passe mis à jour avec succès ! Veuillez vous reconnecter.', 'success');
      setTimeout(clearAuthData, 2000);
    };
    // ================================
    // NAVIGATION ET ANIMATIONS
    // ================================
    function navigateTo(sectionId) {
      if (currentSection === sectionId) return;
     
      navigationHistory.push(currentSection);
      updateBreadcrumb(sectionId);
      showSection(sectionId);
    }
    function goBack() {
      if (navigationHistory.length > 0) {
        const previousSection = navigationHistory.pop();
        showSection(previousSection);
        updateBreadcrumb(previousSection);
      } else {
        showMainMenu();
      }
    }
    function updateBreadcrumb(sectionId) {
      const breadcrumbContent = document.getElementById('breadcrumbContent');
      const navControls = document.getElementById('navControls');
      const navBreadcrumb = document.getElementById('navBreadcrumb');
     
      if (sectionId === 'mainMenu') {
        navBreadcrumb.classList.add('hidden');
        navControls.classList.add('hidden');
        return;
      }
     
      navBreadcrumb.classList.remove('hidden');
      navControls.classList.remove('hidden');
     
      let breadcrumb = '';
      const sections = {
        'newConsultation': 'Nouvelle Consultation',
        'prescriptionEditor': 'Éditeur de Prescription',
        'medicalSummary': 'Résumé Médical',
        'oldConsultation': 'Ancienne Consultation',
        'registry': 'Registre & Statistiques',
        'settings': 'Paramètres'
      };
     
      breadcrumb = `
        <div class="breadcrumb-item" onclick="showMainMenu()">
          <i class="fas fa-home"></i> Accueil
        </div>
        <div class="breadcrumb-separator">/</div>
        <div class="breadcrumb-item active">
          <i class="fas fa-${getSectionIcon(sectionId)}"></i> ${sections[sectionId]}
        </div>
      `;
     
      breadcrumbContent.innerHTML = breadcrumb;
    }
    function getSectionIcon(sectionId) {
      const icons = {
        'newConsultation': 'user-plus',
        'prescriptionEditor': 'file-medical',
        'medicalSummary': 'clipboard-list',
        'oldConsultation': 'history',
        'registry': 'chart-bar',
        'settings': 'cog'
      };
      return icons[sectionId] || 'folder';
    }
    function showSection(sectionId) {
      // Cacher toutes les sections de contenu
      document.querySelectorAll('.content-area').forEach(area => {
        area.classList.remove('active');
      });
      // Cacher le menu principal
      document.getElementById('mainMenu').classList.add('hidden');
      document.getElementById('mainMenu').classList.remove('visible');
      // Afficher la section demandée
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.add('active');
      }
      // Mettre à jour la navigation
      currentSection = sectionId;
      updateBreadcrumb(sectionId);
     
      // Logique spécifique à chaque section
      handleSectionSpecificLogic(sectionId);
    }
    function handleSectionSpecificLogic(sectionId) {
      switch(sectionId) {
        case 'oldConsultation':
          debouncedSearch();
          break;
        case 'prescriptionEditor':
          document.getElementById('prescriptionContent').value = currentPrescription || '';
          const editorAlert = document.getElementById('editorAlert');
          if (editorAlert) editorAlert.innerHTML = '';
          loadPrescriptionTemplate();
          break;
        case 'settings':
          const settingsMenu = document.getElementById('settingsMenu');
          if (settingsMenu) {
            settingsMenu.classList.remove('hidden');
          }
          document.querySelectorAll('#settings > div').forEach(div => {
            if (div.id !== 'settingsMenu') {
              div.classList.add('hidden');
            }
          });
          populateProfileForm();
          break;
      }
    }
    function showMainMenu() {
      navigationHistory = [];
      currentSection = 'mainMenu';
     
      // Cacher toutes les sections
      document.querySelectorAll('.content-area').forEach(section => {
        section.classList.remove('active');
      });
     
      // Cacher les contrôles de navigation
      const navControls = document.getElementById('navControls');
      const navBreadcrumb = document.getElementById('navBreadcrumb');
      if (navControls) navControls.classList.add('hidden');
      if (navBreadcrumb) navBreadcrumb.classList.add('hidden');
     
      // Afficher le menu principal
      const mainMenu = document.getElementById('mainMenu');
      if (mainMenu) {
        mainMenu.classList.remove('hidden');
      }
    }
    function showSettingsSubSection(subSectionId) {
      const settingsMenu = document.getElementById('settingsMenu');
      if (settingsMenu) {
        settingsMenu.classList.add('hidden');
      }
     
      document.querySelectorAll('#settings > div').forEach(div => {
        if (div.id !== 'settingsMenu') {
          div.classList.add('hidden');
        }
      });
     
      if (subSectionId) {
        const subSection = document.getElementById(subSectionId);
        if (subSection) {
          subSection.classList.remove('hidden');
        }
      } else {
        if (settingsMenu) {
          settingsMenu.classList.remove('hidden');
        }
      }
    }
    // ================================
    // FONCTIONS DE L'APPLICATION
    // ================================
    function startApp() {
      loadData();
      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('appContainer').classList.remove('hidden');
     
      document.getElementById('currentUserInfo').textContent = `${storedUser.firstName} ${storedUser.lastName} (${storedUser.role} - ${storedUser.service})`;
      document.getElementById('listServiceDisplay').textContent = storedUser.service;
      document.getElementById('currentYear').textContent = new Date().getFullYear();
     
      showMainMenu();
      updateStats();
      populateRegistryFilters();
      populateServiceSelects();
     
      // Initialiser les débounceurs
      window.debouncedSearch = debounce(searchPatients, 300);
      window.debouncedUpdateStats = debounce(updateStats, 300);
    }
    function populateServiceSelects() {
      const selects = [document.getElementById('regService'), document.getElementById('serviceType'), document.getElementById('serviceFilter')];
      selects.forEach(select => {
        if (select) {
          select.innerHTML = servicesList.map(s => `<option value="${s}">${s}</option>`).join('');
        }
      });
      document.getElementById('regService').addEventListener('change', toggleOtherService);
      document.getElementById('serviceType').addEventListener('change', toggleOtherServiceNew);
    }
    function toggleOtherService() {
      const group = document.getElementById('otherServiceGroup');
      if (document.getElementById('regService').value === 'Autre') {
        group.classList.remove('hidden');
      } else {
        group.classList.add('hidden');
      }
    }
    function toggleOtherServiceNew() {
      const group = document.getElementById('otherServiceGroupNew');
      if (document.getElementById('serviceType').value === 'Autre') {
        group.classList.remove('hidden');
      } else {
        group.classList.add('hidden');
      }
    }
    // ================================
    // GESTION DES PATIENTS
    // ================================
    document.getElementById('newPatientForm').onsubmit = function(e) {
      e.preventDefault();
      const patientName = document.getElementById('patientName').value.trim();
      const patientId = patientName.substring(0, 3).toUpperCase() + Date.now().toString().slice(-4);
      const service = document.getElementById('serviceType').value === 'Autre' ? document.getElementById('otherServiceNew').value : document.getElementById('serviceType').value;
     
      const patient = {
        id: patientId,
        name: patientName,
        age: document.getElementById('patientAge').value,
        gender: document.getElementById('patientGender').value,
        profession: document.getElementById('patientProfession').value,
        phone: document.getElementById('patientPhone').value,
        address: document.getElementById('patientAddress').value,
        bloodGroup: document.getElementById('patientBloodGroup').value,
        rhesus: document.getElementById('patientRhesus').value,
        service: service,
        createdAt: new Date().toISOString()
      };
     
      currentPatient = patient;
      patients.push(patient);
      saveData();
      document.getElementById('currentPatientNameDisplay2').textContent = `${currentPatient.name} (ID: ${currentPatient.id})`;
      document.getElementById('newPatientForm').reset();
      currentPrescription = '';
      navigateTo('prescriptionEditor');
    };
    // ================================
    // PRESCRIPTION
    // ================================
    document.getElementById('prescriptionForm').onsubmit = function(e) {
      e.preventDefault();
      goToSummary();
    };
    function loadPrescriptionTemplate() {
      const templateKey = currentPatient.service in prescriptionTemplates ? currentPatient.service : 'default';
      let template = prescriptionTemplates[templateKey];
      template = template.replace('[NOM]', currentPatient.name)
                         .replace('[AGE]', currentPatient.age)
                         .replace('[SEXE]', currentPatient.gender === 'M' ? 'Masculin' : 'Féminin')
                         .replace('[GROUPE]', currentPatient.bloodGroup)
                         .replace('[RHESUS]', currentPatient.rhesus);
      document.getElementById('prescriptionContent').value = template;
      document.getElementById('prescriptionHeader').innerHTML = `
        <p><strong>Patient:</strong> ${currentPatient.name}</p>
        <p><strong>Âge:</strong> ${currentPatient.age}</p>
        <p><strong>Sexe:</strong> ${currentPatient.gender === 'M' ? 'Masculin' : 'Féminin'}</p>
        <p><strong>Groupe sanguin:</strong> ${currentPatient.bloodGroup} ${currentPatient.rhesus}</p>
        <p><strong>Soignant:</strong> ${storedUser.firstName} ${storedUser.lastName}</p>
        <p><strong>Service:</strong> ${storedUser.service}</p>
      `;
    }
    function goToSummary() {
      currentPrescription = document.getElementById('prescriptionContent').value;
     
      const patientNameDisplay = document.getElementById('currentPatientNameDisplay3');
      if (patientNameDisplay) {
        patientNameDisplay.textContent = `${currentPatient.name} (ID: ${currentPatient.id})`;
      }
     
      // === PRÉ-REMPLISSAGE AUTOMATIQUE DES INFOS DU MÉDECIN ===
      document.getElementById('doctorName').value = `${storedUser.firstName} ${storedUser.lastName}`;
      document.getElementById('doctorContact').value = storedUser.phone || storedUser.email || '';
      document.getElementById('doctorService').value = storedUser.service;
      document.getElementById('consultationCenter').value = 'Centre Médical Principal'; // Tu peux laisser modifiable

      const editorAlert = document.getElementById('editorAlert');
      if (editorAlert) editorAlert.innerHTML = '';
     
      navigateTo('medicalSummary');
    }
    function saveConsultation() {
      if (!currentPatient) {
        showNotification('Erreur: Le patient actuel n\'est pas défini. Veuillez recommencer la consultation.', 'error');
        navigateTo('newConsultation');
        return;
      }
     
      const diseaseType = document.getElementById('diseaseType').value;
      const doctorName = document.getElementById('doctorName').value;
      const doctorService = document.getElementById('doctorService').value;
      const consultationCenter = document.getElementById('consultationCenter').value;
     
      if (!diseaseType || !doctorName || !doctorService || !consultationCenter) {
        showNotification('Veuillez remplir tous les champs obligatoires du Résumé Médical (marqués par *).', 'error');
        return;
      }
      const consultation = {
        id: 'CONS-' + Date.now(),
        patientId: currentPatient.id,
        date: new Date().toISOString().split('T')[0],
        generalDiagnosis: '',
        treatmentDuration: 0,
        prescriptionContent: currentPrescription,
        disease: diseaseType,
        observations: document.getElementById('summaryText').value,
        doctorName: doctorName,
        doctorContact: document.getElementById('doctorContact').value,
        service: doctorService,
        center: consultationCenter,
        createdAt: new Date().toISOString()
      };
      consultations.push(consultation);
      saveData();
     
      currentPatient = null;
      currentPrescription = '';
      showNotification(`Consultation enregistrée pour le patient ${consultation.patientId} !`, 'success');
      document.getElementById('medicalSummary').reset();
     
      // Animation de succès
      const saveBtn = document.querySelector('#medicalSummary .btn-primary');
      const originalHTML = saveBtn.innerHTML;
      saveBtn.innerHTML = '<i class="fas fa-check"></i> Enregistré !';
      saveBtn.classList.add('animate-glow');
     
      setTimeout(() => {
        saveBtn.innerHTML = originalHTML;
        saveBtn.classList.remove('animate-glow');
        showMainMenu();
      }, 1500);
    }
    // ================================
    // RECHERCHE DE PATIENTS
    // ================================
    function searchPatients() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      const listContentDiv = document.getElementById('patientListContent');
      const patientsListContainer = document.getElementById('patientsListContainer');
      const searchLoader = document.getElementById('searchLoader');
      const noResults = document.getElementById('noResults');
     
      const serviceDuSoignant = storedUser ? storedUser.service : 'Consultation générale';
      const listServiceDisplay = document.getElementById('listServiceDisplay');
      if (listServiceDisplay) {
        listServiceDisplay.textContent = serviceDuSoignant;
      }
      // Afficher le loader
      if (patientsListContainer) patientsListContainer.classList.add('hidden');
      if (noResults) noResults.classList.add('hidden');
      if (searchLoader) searchLoader.classList.remove('hidden');
      setTimeout(() => {
        const patientIdsInService = new Set(
          consultations.filter(c => c.service === serviceDuSoignant).map(c => c.patientId)
        );
       
        const patientsInService = patients.filter(p => patientIdsInService.has(p.id));
       
        let patientsToShow = patientsInService.slice().sort((a, b) => {
          const lastA = consultations.filter(c => c.patientId === a.id && c.service === serviceDuSoignant)
            .sort((x, y) => new Date(y.date) - new Date(x.date))[0]?.date || '1970-01-01';
          const lastB = consultations.filter(c => c.patientId === b.id && c.service === serviceDuSoignant)
            .sort((x, y) => new Date(y.date) - new Date(x.date))[0]?.date || '1970-01-01';
          return new Date(lastB) - new Date(lastA);
        });
       
        if (query.length >= 2) {
          patientsToShow = patientsToShow.filter(p =>
            p.name.toLowerCase().includes(query) ||
            p.id.toLowerCase().includes(query) ||
            (p.phone && p.phone.toLowerCase().includes(query))
          );
        } else {
          patientsToShow = patientsToShow.slice(0, 10);
        }
        if (searchLoader) searchLoader.classList.add('hidden');
        if (patientsInService.length === 0 || patientsToShow.length === 0) {
          if (noResults) {
            noResults.classList.remove('hidden');
          }
          if (patientsListContainer) {
            patientsListContainer.classList.add('hidden');
          }
        } else {
          const resultsHtml = patientsToShow.map(p => {
            const lastConsultation = consultations
              .filter(c => c.patientId === p.id && c.service === serviceDuSoignant)
              .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
             
            const lastConsultDate = lastConsultation ? new Date(lastConsultation.date).toLocaleDateString('fr-FR') : 'N/A';
           
            return `
            <div class="patient-search-card" onclick="showPatientDetails('${p.id}')">
              <div class="patient-info">
                <h4>${p.name}</h4>
                <p>${p.age} ans • ${p.gender === 'M' ? 'Homme' : 'Femme'} • ID: ${p.id}</p>
              </div>
              <div class="text-right">
                <small>Dernière consult. : ${lastConsultDate}</small>
                <div class="patient-actions mt-2">
                  <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); continueConsultation('${p.id}')">
                    <i class="fas fa-edit"></i> Continuer
                  </button>
                </div>
              </div>
            </div>
            `;
          }).join('');
         
          if (listContentDiv) {
            listContentDiv.innerHTML = resultsHtml;
          }
          if (patientsListContainer) {
            patientsListContainer.classList.remove('hidden');
          }
        }
        const patientDetails = document.getElementById('patientDetails');
        if (patientDetails) {
          patientDetails.classList.add('hidden');
        }
      }, 300);
    }
    function showPatientDetails(patientId, showAll = false) {
      currentPatient = patients.find(p => p.id === patientId);
      if (!currentPatient) {
        showNotification("Patient non trouvé.", "error");
        return;
      }
      const patientDetails = document.getElementById('patientDetails');
      if (patientDetails) {
        patientDetails.classList.remove('hidden');
        patientDetails.innerHTML = `
          <form id="editPatientForm" onsubmit="savePatientEdit(event, '${patientId}')">
            <div class="details-grid">
              <div class="detail-item">
                <label>ID Patient</label>
                <p>${currentPatient.id}</p>
              </div>
              <div class="detail-item">
                <label>Nom Complet</label>
                <input type="text" value="${currentPatient.name}" readonly class="form-control uppercase-input" />
              </div>
              <div class="detail-item">
                <label>Âge</label>
                <input type="text" id="editAge" value="${currentPatient.age}" class="form-control" />
              </div>
              <div class="detail-item">
                <label>Sexe</label>
                <input type="text" value="${currentPatient.gender === 'M' ? 'Masculin' : 'Féminin'}" readonly class="form-control" />
              </div>
              <div class="detail-item">
                <label>Profession</label>
                <input type="text" id="editProfession" value="${currentPatient.profession || 'N/A'}" class="form-control" />
              </div>
              <div class="detail-item">
                <label>Téléphone</label>
                <input type="text" id="editPhonePatient" value="${currentPatient.phone || 'N/A'}" class="form-control" />
              </div>
              <div class="detail-item">
                <label>Adresse</label>
                <input type="text" id="editAddress" value="${currentPatient.address || 'N/A'}" class="form-control" />
              </div>
              <div class="detail-item">
                <label>Service d'Enregistrement</label>
                <p>${currentPatient.service || 'N/A'}</p>
              </div>
              <div class="detail-item">
                <label>Groupe sanguin</label>
                <p>${currentPatient.bloodGroup} ${currentPatient.rhesus}</p>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Sauvegarder Modifications</button>
          </form>
          <div id="consultationHistory"></div>
          <div class="flex gap-3 mt-4">
            <button class="btn btn-primary" onclick="continueConsultation('${currentPatient.id}')">
              <i class="fas fa-edit"></i> Continuer la consultation
            </button>
            <button class="btn btn-outline" onclick="showAllHistory('${currentPatient.id}')">
              <i class="fas fa-history"></i> Voir tout l'historique
            </button>
          </div>
        `;
      }
      renderHistory(patientId, showAll);
    }
    function savePatientEdit(e, patientId) {
      e.preventDefault();
      const updatedPatient = {
        ...currentPatient,
        age: document.getElementById('editAge').value,
        profession: document.getElementById('editProfession').value,
        phone: document.getElementById('editPhonePatient').value,
        address: document.getElementById('editAddress').value
      };
      const index = patients.findIndex(p => p.id === patientId);
      if (index !== -1) {
        patients[index] = updatedPatient;
      }
      saveData();
      showNotification('Patient mis à jour !', 'success');
      showPatientDetails(patientId);
    }
    function continueConsultation(patientId) {
      currentPatient = patients.find(p => p.id === patientId);
      if (!currentPatient) return;
     
      const display = document.getElementById('currentPatientNameDisplay2');
      if (display) {
        display.textContent = `${currentPatient.name} (ID: ${currentPatient.id})`;
      }
      currentPrescription = '';
      const prescriptionContent = document.getElementById('prescriptionContent');
      if (prescriptionContent) {
        prescriptionContent.value = '';
      }
     
      navigateTo('prescriptionEditor');
    }
    function renderHistory(patientId, showAll = false) {
      const serviceDuSoignant = storedUser ? storedUser.service : 'Consultation générale';
      const historyDiv = document.getElementById('consultationHistory');
      if (!historyDiv) return;
     
      let patientConsultations = consultations
        .filter(c => c.patientId === patientId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      if (!showAll) {
        patientConsultations = patientConsultations.filter(c => c.service === serviceDuSoignant);
      }
     
      let historyHtml = `<h3 class="details-section-header">
        <i class="fas fa-calendar-check"></i>
        ${showAll ? 'Historique complet' : `Historique (${serviceDuSoignant})`}
        <span class="badge">${patientConsultations.length}</span>
      </h3>`;
     
      if (patientConsultations.length === 0) {
        historyHtml += `<p class="text-gray text-center py-4">Aucune consultation trouvée.</p>`;
      } else {
        patientConsultations.forEach((c, index) => {
          const isOtherService = c.service !== serviceDuSoignant;
          const cardClass = `consultation-item ${isOtherService ? 'other-service' : ''}`;
          const serviceNote = isOtherService ? `<span class="consultation-service">${c.service}</span>` : '';
         
          historyHtml += `
          <div class="${cardClass}">
            <div class="consultation-header">
              <span class="consultation-date">
                <i class="fas fa-calendar"></i> ${new Date(c.date).toLocaleDateString('fr-FR')}
              </span>
              ${serviceNote}
            </div>
            <div class="mb-3">
              <strong><i class="fas fa-disease"></i> Type de Maladie :</strong> ${c.disease || 'N/A'}
            </div>
            <div class="mb-3">
              <strong><i class="fas fa-file-prescription"></i> Prescription :</strong>
              <div class="mt-2 p-3 bg-light rounded border">
                <pre style="margin: 0; white-space: pre-wrap;">${c.prescriptionContent || 'N/A'}</pre>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
              <div><strong><i class="fas fa-user-md"></i> Soignant :</strong> ${c.doctorName || 'N/A'}</div>
              <div><strong><i class="fas fa-phone"></i> Contact :</strong> ${c.doctorContact || 'N/A'}</div>
              <div><strong><i class="fas fa-stethoscope"></i> Service :</strong> ${c.service || 'N/A'}</div>
              <div><strong><i class="fas fa-hospital"></i> Centre :</strong> ${c.center || 'N/A'}</div>
            </div>
          </div>
          `;
        });
      }
     
      historyDiv.innerHTML = historyHtml;
    }
    function showAllHistory(patientId) {
      renderHistory(patientId, true);
    }
    // ================================
    // ÉDITEUR DE PRESCRIPTION
    // ================================
    function addTable() {
      const contentArea = document.getElementById('prescriptionContent');
      if (!contentArea) return;
     
      let columns = parseInt(prompt("Nombre de colonnes (max 4):", 3)) || 3;
      let rows = parseInt(prompt("Nombre de lignes (max 10):", 4)) || 4;
      if (isNaN(columns) || columns < 1 || columns > 4) columns = 3;
      if (isNaN(rows) || rows < 1 || rows > 10) rows = 4;
      const cellWidth = 20; // Amélioré pour plus d'espace comme dans Word
      let tableContent = '\n';
     
      const createSeparator = (cols) => {
        let sep = '+';
        for (let i = 0; i < cols; i++) {
          sep += '-'.repeat(cellWidth + 2) + '+';
        }
        return sep;
      };
      const createRow = (cols, isHeader = false, rowNum = 0) => {
        let row = '|';
        for (let i = 0; i < cols; i++) {
          let cellContent = isHeader ? `COL ${i + 1}` : `L${rowNum}C${i + 1}`;
          if (cellContent.length > cellWidth) {
            cellContent = cellContent.substring(0, cellWidth);
          } else {
            cellContent = cellContent + ' '.repeat(cellWidth - cellContent.length);
          }
          row += ` ${cellContent} |`;
        }
        return row;
      };
      tableContent += createSeparator(columns) + '\n';
      tableContent += createRow(columns, true) + '\n';
      tableContent += createSeparator(columns) + '\n';
      for (let i = 1; i <= rows; i++) {
        tableContent += createRow(columns, false, i) + '\n';
        tableContent += createSeparator(columns) + '\n';
      }
     
      contentArea.value += tableContent;
    }
    function addSection() {
      const contentArea = document.getElementById('prescriptionContent');
      if (!contentArea) return;
     
      const sectionTitle = prompt("Titre de la section:", "NOUVELLE SECTION");
      if (sectionTitle) {
        const newSection = `\n\n=== ${sectionTitle.toUpperCase()} ===\n\n`;
        contentArea.value += newSection;
      }
    }
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text(document.getElementById('prescriptionContent').value, 10, 10);
      doc.save('prescription.pdf');
    }
    function exportToWord() {
      const content = document.getElementById('prescriptionContent').value;
      const blob = new Blob([content], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'prescription.doc';
      a.click();
      URL.revokeObjectURL(url);
    }
    // ================================
    // REGISTRE ET STATISTIQUES
    // ================================
    function populateRegistryFilters() {
      const uniqueCenters = [...new Set(consultations.map(c => c.center).filter(Boolean))];
      const centerFilter = document.getElementById('centerFilter');
      if (centerFilter) {
        centerFilter.innerHTML = '<option value="all">Tous les centres</option>';
        uniqueCenters.forEach(center => {
          centerFilter.innerHTML += `<option value="${center}">${center}</option>`;
        });
      }
      const serviceFilter = document.getElementById('serviceFilter');
      if (serviceFilter) {
        serviceFilter.innerHTML = '<option value="all">Tous les services</option>';
        servicesList.forEach(service => {
          serviceFilter.innerHTML += `<option value="${service}">${service}</option>`;
        });
      }
    }
    function updateStats() {
      const diseaseSearch = document.getElementById('diseaseSearchInput')?.value.toLowerCase() || '';
      const dateStart = document.getElementById('dateFilterStart')?.value || '';
      const dateEnd = document.getElementById('dateFilterEnd')?.value || '';
      const centerFilterValue = document.getElementById('centerFilter')?.value || 'all';
      const serviceFilterValue = document.getElementById('serviceFilter')?.value || 'all';
     
      let filteredConsultations = consultations.filter(c => {
        const consultDate = new Date(c.date);
        if (diseaseSearch && !c.disease.toLowerCase().includes(diseaseSearch)) return false;
        if (dateStart && consultDate < new Date(dateStart)) return false;
        if (dateEnd) {
          const endDate = new Date(dateEnd);
          endDate.setDate(endDate.getDate() + 1);
          if (consultDate >= endDate) return false;
        }
        if (centerFilterValue !== 'all' && c.center !== centerFilterValue) return false;
        if (serviceFilterValue !== 'all' && c.service !== serviceFilterValue) return false;
        return true;
      });
     
      const totalConsultations = filteredConsultations.length;
      const urgencesCount = filteredConsultations.filter(c => c.service === 'Urgences').length;
      const patientIds = new Set(filteredConsultations.map(c => c.patientId));
      const totalPatients = patientIds.size;
     
      const totalPatientsEl = document.getElementById('totalPatients');
      const totalConsultationsEl = document.getElementById('totalConsultations');
      const urgencesCountEl = document.getElementById('urgencesCount');
      const diseaseCountEl = document.getElementById('diseaseCount');
     
      if (totalPatientsEl) totalPatientsEl.textContent = totalPatients;
      if (totalConsultationsEl) totalConsultationsEl.textContent = totalConsultations;
      if (urgencesCountEl) urgencesCountEl.textContent = urgencesCount;
     
      const diseaseCount = {};
      const diseaseServiceMap = {};
     
      filteredConsultations.forEach(c => {
        const normalizedDisease = c.disease.trim().toUpperCase();
        diseaseCount[normalizedDisease] = (diseaseCount[normalizedDisease] || 0) + 1;
        if (!diseaseServiceMap[normalizedDisease]) {
          diseaseServiceMap[normalizedDisease] = { service: c.service, center: c.center };
        }
      });
     
      if (diseaseCountEl) diseaseCountEl.textContent = Object.keys(diseaseCount).length;
     
      const diseaseStatsDiv = document.getElementById('diseaseStats');
      const sortedDiseases = Object.entries(diseaseCount).sort(([, a], [, b]) => b - a);
     
      let tableContent = '';
      const col1Width = 25;
      const col2Width = 15;
      const col3Width = 12;
      const col4Width = 12;
     
      const createSeparator = () => {
        return '+'.padEnd(col1Width + 1, '-') + '+'.padEnd(col2Width + 1, '-') + '+'.padEnd(col3Width + 1, '-') + '+'.padEnd(col4Width + 1, '-') + '+\n';
      };
     
      if (sortedDiseases.length === 0) {
        tableContent = '<p class="text-center py-4 text-gray">Aucune donnée correspondante</p>';
      } else {
        tableContent += createSeparator();
        tableContent += '| ' + 'Maladie'.padEnd(col1Width - 1) + '| ' + 'Total'.padEnd(col2Width - 1) + '| ' + 'Service'.padEnd(col3Width - 1) + '| ' + 'Centre'.padEnd(col4Width - 1) + '|\n';
        tableContent += createSeparator();
       
        sortedDiseases.slice(0, 10).forEach(([disease, count]) => {
          const info = diseaseServiceMap[disease] || {};
          const maladieDisplay = disease.length > col1Width ? disease.substring(0, col1Width - 2) + '..' : disease.padEnd(col1Width);
          const countDisplay = String(count).padEnd(col2Width);
          const serviceDisplay = (info.service || 'N/A').substring(0, col3Width - 2).padEnd(col3Width);
          const centerDisplay = (info.center || 'N/A').substring(0, col4Width - 2).padEnd(col4Width);
         
          tableContent += `| ${maladieDisplay} | ${countDisplay} | ${serviceDisplay} | ${centerDisplay} |\n`;
        });
       
        tableContent += createSeparator();
      }
     
      if (diseaseStatsDiv) {
        diseaseStatsDiv.innerHTML = `<pre class="font-mono text-sm">${tableContent}</pre>`;
      }
    }
    // ================================
    // SAUVEGARDE ET CHARGEMENT
    // ================================
    function saveData() {
      const data = { patients, consultations };
      localStorage.setItem('medicalData', JSON.stringify(data));
      updateStats();
      populateRegistryFilters();
    }
    function loadData() {
      const saved = localStorage.getItem('medicalData');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          patients = data.patients || [];
          consultations = data.consultations || [];
        } catch (e) {
          console.error('Erreur de chargement des données:', e);
          patients = [];
          consultations = [];
        }
      }
    }
    // ================================
    // EXPORT CSV
    // ================================
    function exportData() {
      const diseaseSearch = document.getElementById('diseaseSearchInput')?.value.toLowerCase() || '';
      const dateStart = document.getElementById('dateFilterStart')?.value || '';
      const dateEnd = document.getElementById('dateFilterEnd')?.value || '';
      const centerFilterValue = document.getElementById('centerFilter')?.value || 'all';
      const serviceFilterValue = document.getElementById('serviceFilter')?.value || 'all';
     
      const filteredConsultations = consultations.filter(c => {
        if (diseaseSearch && !c.disease.toLowerCase().includes(diseaseSearch)) return false;
        if (dateStart && new Date(c.date) < new Date(dateStart)) return false;
        if (dateEnd) {
          const endDate = new Date(dateEnd);
          endDate.setDate(endDate.getDate() + 1);
          if (new Date(c.date) >= endDate) return false;
        }
        if (centerFilterValue !== 'all' && c.center !== centerFilterValue) return false;
        if (serviceFilterValue !== 'all' && c.service !== serviceFilterValue) return false;
        return true;
      });
      if (filteredConsultations.length === 0) {
        showNotification('Aucune donnée à exporter avec les filtres actuels.', 'warning');
        return;
      }
      let csvContent = 'ID Patient,Nom,Date,Maladie,Service,Centre,Médecin\n';
     
      filteredConsultations.forEach(c => {
        const patient = patients.find(p => p.id === c.patientId);
        const row = [
          `"${c.patientId}"`,
          `"${patient ? patient.name : 'N/A'}"`,
          `"${c.date}"`,
          `"${c.disease}"`,
          `"${c.service}"`,
          `"${c.center}"`,
          `"${c.doctorName}"`
        ].join(',');
        csvContent += row + '\n';
      });
      const BOM = "\uFEFF";
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
    a.href = url;
    a.download = `export_medical_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
     
    showNotification('Export CSV réussi !', 'success');
  }
  // ================================
  // PARAMÈTRES
  // ================================
  function populateProfileForm() {
    if (!storedUser) return;
     
    const editFirstName = document.getElementById('editFirstName');
    const editLastName = document.getElementById('editLastName');
    const editUsername = document.getElementById('editUsername');
    const editEmail = document.getElementById('editEmail');
    const editPhone = document.getElementById('editPhone');
    const editRole = document.getElementById('editRole');
    const editService = document.getElementById('editService');
     
    if (editFirstName) editFirstName.value = storedUser.firstName || '';
    if (editLastName) editLastName.value = storedUser.lastName || '';
    if (editUsername) editUsername.value = storedUser.username || '';
    if (editEmail) editEmail.value = storedUser.email || '';
    if (editPhone) editPhone.value = storedUser.phone || '';
    if (editRole) editRole.value = storedUser.role || 'Autre';
    if (editService) editService.value = storedUser.service || 'Autre';
     
    const profileAlert = document.getElementById('profileAlert');
    if (profileAlert) profileAlert.innerHTML = '';
  }
  // ================================
  // INITIALISATION
  // ================================
  window.onload = function() {
    checkAuth();
     
    // Initialiser les écouteurs d'événements
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.addEventListener('input', () => {
        if (window.debouncedSearch) window.debouncedSearch();
      });
    }
     
    const diseaseSearchInput = document.getElementById('diseaseSearchInput');
    if (diseaseSearchInput) {
      diseaseSearchInput.addEventListener('input', () => {
        if (window.debouncedUpdateStats) window.debouncedUpdateStats();
      });
    }
     
    const dateFilterStart = document.getElementById('dateFilterStart');
    if (dateFilterStart) {
      dateFilterStart.addEventListener('input', () => {
        if (window.debouncedUpdateStats) window.debouncedUpdateStats();
      });
    }
     
    const dateFilterEnd = document.getElementById('dateFilterEnd');
    if (dateFilterEnd) {
      dateFilterEnd.addEventListener('input', () => {
        if (window.debouncedUpdateStats) window.debouncedUpdateStats();
      });
    }
     
    const centerFilter = document.getElementById('centerFilter');
    if (centerFilter) {
      centerFilter.addEventListener('change', () => {
        if (window.debouncedUpdateStats) window.debouncedUpdateStats();
      });
    }
     
    const serviceFilter = document.getElementById('serviceFilter');
    if (serviceFilter) {
      serviceFilter.addEventListener('change', () => {
        if (window.debouncedUpdateStats) window.debouncedUpdateStats();
      });
    }
  };
  </script>
</body>
</html>
