<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MediTrack Pro — Gestion Médicale Intelligente</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --primary-light: #eef2ff;
      --primary-gradient: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%);
      --secondary: #7209b7;
      --secondary-light: #f3e8ff;
      --secondary-gradient: linear-gradient(135deg, #7209b7 0%, #6a08a6 100%);
      --success: #4cc9f0;
      --success-light: #e6f7ff;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --danger: #e63946;
      --danger-light: #ffe6e9;
      --warning: #ffb703;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 10px 30px rgba(67, 97, 238, 0.15);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --radius: 16px;
      --radius-sm: 8px;
      --glass: rgba(255, 255, 255, 0.9);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
      color: var(--dark);
      overflow-x: hidden;
      position: relative;
    }
    body::before {
      content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle at 20% 80%, rgba(67, 97, 238, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(114, 9, 183, 0.1) 0%, transparent 50%);
      z-index: -1;
    }
    .hidden { display: none !important; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .justify-between { justify-content: space-between; }
    .gap-4 { gap: 1rem; }
    .gap-6 { gap: 1.5rem; }
    .p-6 { padding: 1.5rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .w-full { width: 100%; }
    .text-center { text-align: center; }
    .font-bold { font-weight: 700; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .uppercase-input { text-transform: uppercase; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .animate-fadeIn { animation: fadeIn 0.6s ease-out; }
    .animate-slideUp { animation: slideUp 0.5s ease-out; }
    .animate-float { animation: float 3s ease-in-out infinite; }
    .animate-pulse { animation: pulse 2s infinite; }
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      backdrop-filter: blur(10px);
    }
    .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3); }
    .btn-primary:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
    .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
    .btn-outline:hover { background: var(--primary); color: white; }
    .btn-back { background: var(--gray-light); color: var(--gray); }
    .btn-back:hover { background: #dee2e6; transform: translateX(-3px); }
    .form-control {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: var(--radius-sm);
      transition: var(--transition);
      background: white;
      backdrop-filter: blur(10px);
    }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15); }
    .auth-container {
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2.5rem;
      max-width: 500px;
      width: 100%;
      margin: 0 auto;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .app-header {
      background: var(--glass);
      padding: 1rem 2rem;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }
    .logo { font-size: 1.75rem; font-weight: 800; display: flex; align-items: center; gap: 0.75rem; color: var(--primary); }
    .user-info { font-weight: 600; color: var(--gray); background: var(--primary-light); padding: 0.5rem 1rem; border-radius: 50px; backdrop-filter: blur(10px); }
    .nav-controls { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .menu-card {
      background: var(--glass);
      border-radius: var(--radius);
      padding: 2rem 1.5rem;
      box-shadow: var(--shadow);
      text-align: center;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: var(--transition);
      backdrop-filter: blur(10px);
    }
    .menu-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: var(--shadow-hover); }
    .menu-card i { font-size: 3rem; margin-bottom: 1rem; color: var(--primary); animation: float 3s ease-in-out infinite; }
    .content-area { display: none; }
    .content-area.active { display: block; animation: slideUp 0.5s ease-out; }
    .content-header {
      margin-bottom: 2rem;
      background: var(--glass);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .glass { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: var(--radius); }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideUp 0.3s ease-out;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 400px;
    }
    .notification.success { background: linear-gradient(135deg, #198754 0%, #146c43 100%); }
    .notification.error { background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%); }
    .patient-search-card {
      background: var(--glass);
      padding: 1.25rem 1.5rem;
      border-radius: var(--radius-sm);
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
    }
    .patient-search-card:hover { background: var(--primary-light); transform: translateX(5px); }
    .loading-spinner {
      width: 40px; height: 40px; border: 3px solid var(--gray-light); border-top-color: var(--primary);
      border-radius: 50%; animation: spin 1s linear infinite; margin: 2rem auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="notificationContainer"></div>

  <!-- Auth -->
  <div id="authScreen" class="flex items-center justify-center min-h-screen">
    <div class="auth-container animate-slideUp">
      <div class="app-logo text-center mb-8">
        <h1><i class="fas fa-heartbeat animate-pulse"></i> <span style="background:var(--primary-gradient);-webkit-background-clip:text;background-clip:text;color:transparent;">MediTrack Pro</span></h1>
        <p>Système de gestion médicale sécurisé</p>
      </div>

      <div id="loginView">
        <h2 class="text-2xl font-bold mb-6 text-center">Connexion</h2>
        <form id="loginForm">
          <div class="form-group mb-4"><label>Email</label><input type="email" id="userEmail" class="form-control" required /></div>
          <div class="form-group mb-6"><label>Mot de passe</label><input type="password" id="userPassword" class="form-control" required /></div>
          <button type="submit" class="btn btn-primary w-full">Connexion</button>
          <p class="text-center mt-4"><a href="#" onclick="toggleAuthView('register')" class="text-primary hover:underline">Créer un compte</a></p>
        </form>
      </div>

      <div id="registerView" class="hidden">
        <h2 class="text-2xl font-bold mb-6 text-center">Inscription</h2>
        <form id="registerForm">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="form-group"><label>Prénom</label><input type="text" id="regFirstName" class="form-control uppercase-input" required /></div>
            <div class="form-group"><label>Nom</label><input type="text" id="regLastName" class="form-control uppercase-input" required /></div>
          </div>
          <div class="form-group mb-4"><label>Email *</label><input type="email" id="regEmail" class="form-control" required /></div>
          <div class="form-group mb-4"><label>Rôle</label><select id="regRole" class="form-control">
            <option>Médecin</option><option>Infirmier</option><option>Sage-femme</option><option>Kiné</option><option>Autre</option>
          </select></div>
          <div class="form-group mb-4"><label>Service *</label><select id="regService" class="form-control"></select></div>
          <div id="otherServiceGroup" class="form-group hidden mb-4"><label>Précisez</label><input type="text" id="regOtherService" class="form-control uppercase-input" /></div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="form-group"><label>Mot de passe *</label><input type="password" id="regPassword" class="form-control" required minlength="6" /></div>
            <div class="form-group"><label>Confirmer *</label><input type="password" id="regConfirmPassword" class="form-control" required /></div>
          </div>
          <button type="submit" class="btn btn-primary w-full">S'inscrire</button>
          <p class="text-center mt-4"><a href="#" onclick="toggleAuthView('login')" class="text-primary hover:underline">Déjà inscrit ?</a></p>
        </form>
      </div>
    </div>
  </div>

  <!-- App -->
  <div id="appContainer" class="hidden flex-col min-h-screen">
    <div class="app-header">
      <div class="logo"><i class="fas fa-heartbeat"></i> MediTrack Pro</div>
      <div class="user-info" id="currentUserInfo"></div>
    </div>

    <div class="p-6 flex-1">
      <div id="navControls" class="nav-controls hidden">
        <button class="btn btn-back" onclick="goBack()"><i class="fas fa-arrow-left"></i> Retour</button>
        <button class="btn btn-outline" onclick="showMainMenu()"><i class="fas fa-home"></i> Accueil</button>
      </div>

      <div id="mainMenu">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="menu-card" onclick="showSection('newConsultation')"><i class="fas fa-user-plus"></i><h3>Nouvelle Consultation</h3></div>
          <div class="menu-card" onclick="showSection('oldConsultation')"><i class="fas fa-history"></i><h3>Ancienne Consultation</h3></div>
          <div class="menu-card" onclick="showSection('registry')"><i class="fas fa-chart-bar"></i><h3>Registre</h3></div>
          <div class="menu-card" onclick="supabase.auth.signOut().then(() => location.reload())"><i class="fas fa-sign-out-alt"></i><h3>Déconnexion</h3></div>
        </div>
      </div>

      <!-- Nouvelle Consultation -->
      <div id="newConsultation" class="content-area">
        <div class="content-header"><h2><i class="fas fa-user-plus"></i> Nouvelle Consultation</h2></div>
        <div class="glass p-6">
          <form id="newPatientForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group"><label>Nom complet *</label><input type="text" id="patientName" class="form-control uppercase-input" required /></div>
              <div class="form-group"><label>Date de naissance</label><input type="date" id="patientBirthDate" class="form-control" /></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group"><label>Sexe *</label><select id="patientGender" class="form-control" required><option value="M">Masculin</option><option value="F">Féminin</option></select></div>
              <div class="form-group"><label>Téléphone</label><input type="text" id="patientPhone" class="form-control" /></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group"><label>Groupe sanguin</label><input type="text" id="patientBloodGroup" class="form-control uppercase-input" /></div>
              <div class="form-group"><label>Rhésus</label><select id="patientRhesus" class="form-control"><option value="">Non spécifié</option><option value="+">+</option><option value="-">-</option></select></div>
            </div>
            <div class="form-group mb-6"><label>Service *</label><select id="serviceType" class="form-control" required></select></div>
            <div id="otherServiceGroupNew" class="form-group hidden mb-6"><label>Précisez</label><input type="text" id="otherServiceNew" class="form-control uppercase-input" /></div>
            <button type="submit" class="btn btn-primary">Continuer vers prescription</button>
          </form>
        </div>
      </div>

      <!-- Éditeur Prescription -->
      <div id="prescriptionEditor" class="content-area">
        <div class="content-header"><h2><i class="fas fa-file-medical"></i> Prescription</h2><p id="currentPatientNameDisplay2"></p></div>
        <div class="glass p-6">
          <div class="flex gap-4 mb-4">
            <button class="btn btn-secondary" onclick="addSection()">Ajouter Section</button>
            <button class="btn btn-secondary" onclick="addTable()">Ajouter Tableau</button>
            <button class="btn btn-primary" onclick="exportToPDF()">PDF</button>
          </div>
          <textarea id="prescriptionContent" class="w-full p-4 border-2 rounded-lg" rows="15"></textarea>
          <div class="mt-6"><button onclick="goToSummary()" class="btn btn-primary">Suivant → Résumé</button></div>
        </div>
      </div>

      <!-- Résumé -->
      <div id="medicalSummary" class="content-area">
        <div class="content-header"><h2><i class="fas fa-clipboard-list"></i> Résumé</h2><p id="currentPatientNameDisplay3"></p></div>
        <div class="glass p-6">
          <form onsubmit="event.preventDefault(); saveConsultation();">
            <div class="form-group mb-6"><label>Maladie *</label><input type="text" id="diseaseType" class="form-control uppercase-input" required /></div>
            <div class="form-group mb-6"><label>Centre *</label><input type="text" id="consultationCenter" class="form-control" required /></div>
            <button type="submit" class="btn btn-primary">Enregistrer Consultation</button>
          </form>
        </div>
      </div>

      <!-- Ancienne Consultation -->
      <div id="oldConsultation" class="content-area">
        <div class="content-header"><h2><i class="fas fa-history"></i> Ancienne Consultation</h2></div>
        <div class="glass p-6 mb-6">
          <input type="text" id="searchInput" class="form-control" placeholder="Rechercher patient..." oninput="searchPatients()" />
        </div>
        <div id="patientsListContainer"><div id="patientListContent"></div></div>
      </div>

      <!-- Registre -->
      <div id="registry" class="content-area">
        <div class="content-header"><h2><i class="fas fa-chart-bar"></i> Registre</h2></div>
        <div class="glass p-6 text-center">
          <p class="text-xl">Patients totaux : <span id="totalPatients" class="font-bold text-primary">0</span></p>
          <p class="text-xl">Consultations : <span id="totalConsultations" class="font-bold text-primary">0</span></p>
        </div>
      </div>
    </div>

    <div class="app-footer p-4 text-center text-sm text-gray-600">
      MediTrack Pro © 2025 — Données synchronisées sur Supabase
    </div>
  </div>

  <script>
    const { createClient } = supabase;
    const supabase = createClient('https://huhckdnnekiglhwetili.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1aGNrZG5uZWtpZ2xod2V0aWxpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NTU3MjYsImV4cCI6MjA4MjIzMTcyNn0.tyFb-ICxAZmw8ktpzb8MPjw0Bwb5-2a82CCSYgS9QEU');

    let currentUser = null;
    let currentPatient = null;
    let currentPrescription = '';
    let userService = '';

    const servicesList = ['Cardiologie','Pédiatrie','Urgences','Consultation générale','Gynécologie','Médecine Interne','Autre'].sort();

    function showNotification(msg, type = 'success') {
      const n = document.createElement('div');
      n.className = `notification ${type}`;
      n.textContent = msg;
      document.getElementById('notificationContainer').appendChild(n);
      setTimeout(() => n.remove(), 4000);
    }

    function toggleAuthView(v) {
      document.getElementById('loginView').classList.toggle('hidden', v !== 'login');
      document.getElementById('registerView').classList.toggle('hidden', v !== 'register');
    }

    document.getElementById('loginForm').onsubmit = async e => {
      e.preventDefault();
      const { data, error } = await supabase.auth.signInWithPassword({
        email: document.getElementById('userEmail').value,
        password: document.getElementById('userPassword').value
      });
      if (error) showNotification(error.message, 'error');
      else await startApp(data.user);
    };

    document.getElementById('registerForm').onsubmit = async e => {
      e.preventDefault();
      const pwd = document.getElementById('regPassword').value;
      if (pwd !== document.getElementById('regConfirmPassword').value) return showNotification('Mots de passe différents', 'error');
      const service = document.getElementById('regService').value === 'Autre' ? document.getElementById('regOtherService').value.toUpperCase() : document.getElementById('regService').value;
      const { data, error } = await supabase.auth.signUp({ email: document.getElementById('regEmail').value, password: pwd });
      if (error) showNotification(error.message, 'error');
      else {
        await supabase.from('sante_utilisateur').insert({ user_id: data.user.id, role: document.getElementById('regRole').value, service });
        showNotification('Inscription réussie ! Connectez-vous.', 'success');
        toggleAuthView('login');
      }
    };

    async function startApp(user) {
      currentUser = user;
      const { data } = await supabase.from('sante_utilisateur').select('service').eq('user_id', user.id).single();
      userService = data.service;
      document.getElementById('currentUserInfo').textContent = `${user.email} (${userService})`;
      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('appContainer').classList.remove('hidden');
      populateServiceSelects();
      showMainMenu();
      updateStats();
    }

    function showMainMenu() {
      document.querySelectorAll('.content-area').forEach(s => s.classList.remove('active'));
      document.getElementById('mainMenu').classList.remove('hidden');
      document.getElementById('navControls').classList.add('hidden');
    }

    function showSection(id) {
      document.querySelectorAll('.content-area').forEach(s => s.classList.remove('active'));
      document.getElementById('mainMenu').classList.add('hidden');
      document.getElementById(id).classList.add('active');
      document.getElementById('navControls').classList.remove('hidden');
      if (id === 'prescriptionEditor') loadPrescriptionTemplate();
    }

    function goBack() {
      if (currentSection === 'prescriptionEditor') showSection('newConsultation');
      else if (currentSection === 'medicalSummary') showSection('prescriptionEditor');
      else showMainMenu();
    }

    document.getElementById('newPatientForm').onsubmit = async e => {
      e.preventDefault();
      const birth = document.getElementById('patientBirthDate').value;
      const age = birth ? Math.floor((Date.now() - new Date(birth)) / (31557600000)) : null;
      const service = document.getElementById('serviceType').value === 'Autre' ? document.getElementById('otherServiceNew').value.toUpperCase() : document.getElementById('serviceType').value;
      const { data, error } = await supabase.from('sante_patient').insert([{
        nom: document.getElementById('patientName').value.toUpperCase(),
        date_naissance: birth || null,
        sexe: document.getElementById('patientGender').value,
        telephone: document.getElementById('patientPhone').value || null,
        groupe_sanguin: document.getElementById('patientBloodGroup').value.toUpperCase() || null,
        rhesus: document.getElementById('patientRhesus').value || null,
        service
      }]).select();
      if (error) showNotification(error.message, 'error');
      else {
        currentPatient = data[0];
        currentPatient.age = age;
        document.getElementById('currentPatientNameDisplay2').textContent = currentPatient.nom;
        showSection('prescriptionEditor');
      }
    };

    function loadPrescriptionTemplate() {
      const age = currentPatient.age || 'N/A';
      const template = `=== CONSULTATION ===
Patient: ${currentPatient.nom} | Âge: ${age} ans | Sexe: ${currentPatient.sexe === 'M' ? 'Masculin' : 'Féminin'}
Groupe sanguin: ${currentPatient.groupe_sanguin || ''}${currentPatient.rhesus || ''}

+-----------------------------------+-----------------------------------+-----------------------------------+
| Symptômes                         | Diagnostic                        | Traitement                        |
+-----------------------------------+-----------------------------------+-----------------------------------+
|                                   |                                   |                                   |
+-----------------------------------+-----------------------------------+-----------------------------------+

Observations:`;
      document.getElementById('prescriptionContent').value = template;
    }

    function goToSummary() {
      currentPrescription = document.getElementById('prescriptionContent').value;
      document.getElementById('currentPatientNameDisplay3').textContent = currentPatient.nom;
      showSection('medicalSummary');
    }

    async function saveConsultation() {
      const { error } = await supabase.from('sante_consultation').insert([{
        patient_id: currentPatient.id,
        diagnostic: document.getElementById('diseaseType').value.toUpperCase(),
        symptomes: currentPrescription,
        center: document.getElementById('consultationCenter').value,
        service: userService,
        personnel_responsable_id: currentUser.id,
        date: new Date().toISOString().split('T')[0]
      }]);
      if (error) showNotification(error.message, 'error');
      else {
        showNotification('Consultation enregistrée !', 'success');
        currentPatient = null;
        showMainMenu();
        updateStats();
      }
    }

    async function searchPatients() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      let { data: patients } = await supabase.from('sante_patient').select('*').ilike('service', userService);
      if (query) patients = patients.filter(p => p.nom.toLowerCase().includes(query) || (p.telephone && p.telephone.includes(query)));
      const html = patients.map(p => `
        <div class="patient-search-card" onclick="continueWithPatient(${p.id})">
          <div><h4>${p.nom}</h4><p>${p.telephone || 'N/A'}</p></div>
          <button class="btn btn-primary">Continuer</button>
        </div>
      `).join('');
      document.getElementById('patientListContent').innerHTML = html || '<p class="text-center text-gray-500">Aucun patient</p>';
    }

    async function continueWithPatient(id) {
      const { data } = await supabase.from('sante_patient').select('*').eq('id', id).single();
      currentPatient = data;
      currentPatient.age = data.date_naissance ? Math.floor((Date.now() - new Date(data.date_naissance)) / 31557600000) : 'N/A';
      document.getElementById('currentPatientNameDisplay2').textContent = currentPatient.nom;
      showSection('prescriptionEditor');
    }

    async function updateStats() {
      const { count: patients } = await supabase.from('sante_patient').select('*', { count: 'exact' });
      const { count: consultations } = await supabase.from('sante_consultation').select('*', { count: 'exact' });
      document.getElementById('totalPatients').textContent = patients || 0;
      document.getElementById('totalConsultations').textContent = consultations || 0;
    }

    function populateServiceSelects() {
      ['regService', 'serviceType'].forEach(id => {
        const s = document.getElementById(id);
        s.innerHTML = servicesList.map(v => `<option>${v}</option>`).join('');
      });
      document.getElementById('regService').onchange = () => document.getElementById('otherServiceGroup').classList.toggle('hidden', document.getElementById('regService').value !== 'Autre');
      document.getElementById('serviceType').onchange = () => document.getElementById('otherServiceGroupNew').classList.toggle('hidden', document.getElementById('serviceType').value !== 'Autre');
    }

    function addTable() { document.getElementById('prescriptionContent').value += '\n+-----------------------------------+-----------------------------------+-----------------------------------+\n|                                   |                                   |                                   |\n+-----------------------------------+-----------------------------------+-----------------------------------+\n'; }
    function addSection() { const t = prompt('Titre'); if(t) document.getElementById('prescriptionContent').value += `\n\n=== ${t.toUpperCase()} ===\n\n`; }
    function exportToPDF() { const { jsPDF } = window.jspdf; new jsPDF().text(document.getElementById('prescriptionContent').value, 10, 10).save('prescription.pdf'); }

    supabase.auth.onAuthStateChange((_, session) => { if (session) startApp(session.user); });
    populateServiceSelects();
  </script>
</body>
</html>
